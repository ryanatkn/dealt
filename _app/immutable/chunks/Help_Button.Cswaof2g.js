var Rt=Object.defineProperty;var St=l=>{throw TypeError(l)};var Vt=(l,n,t)=>n in l?Rt(l,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[n]=t;var Mt=(l,n,t)=>Vt(l,typeof n!="symbol"?n+"":n,t),It=(l,n,t)=>n.has(l)||St("Cannot "+t);var G=(l,n,t)=>(It(l,n,"read from private field"),t?t.call(l):n.get(l)),_t=(l,n,t)=>n.has(l)?St("Cannot add the same private member more than once"):n instanceof WeakSet?n.add(l):n.set(l,t),wt=(l,n,t,o)=>(It(l,n,"write to private field"),o?o.call(l,t):n.set(l,t),t);import{a as X,t as O,n as lt,c as ct,b as at}from"./disclose-version.Ds06f9Vu.js";import{aJ as Wt,K as e,k as Ft,j as Xt,a1 as Lt,a4 as Jt,v as J,m as q,o as Q,q as $,L as U,c as D,s as N,D as Et,r as R,n as rt,a0 as m,u as Pt,W as i,aI as V}from"./runtime.5k9ShzZt.js";import{d as st,o as Kt,k as j,s as gt}from"./render.CAjsxhF5.js";import{i as W,p as tt,c as d}from"./props.lofZ2jro.js";import{s as dt}from"./snippet.CcawutmI.js";import{b as et,r as zt,t as Z,s as H,g as Ot,a as Zt,e as Ct}from"./string.25aLtQ0-.js";import{t as Gt,s as Qt}from"./index.DteDSzYE.js";import{ao as $t,e as Ht,P as te,u as ee,ap as ne,Q as it,aq as pt,ar as ie,as as le,at as oe,au as Ut,K as re,M as Yt,N as se,a2 as ae,L as mt,av as ue,c as ce,F as de}from"./renderer_components.DC7U4vDT.js";import{c as _e}from"./svelte-component.BgFhLqea.js";import{b as ve}from"./preload-helper.DV2ohNv5.js";function ge(l){let n=0,t=Jt(0),o;return()=>{Wt()&&(e(t),Ft(()=>(n===0&&(o=Xt(()=>l(()=>$t(t)))),n+=1,()=>{Lt().then(()=>{n-=1,n===0&&(o==null||o(),o=void 0)})})))}}var ht,ft;class Tt{constructor(n,t){_t(this,ht);_t(this,ft);wt(this,ht,n),wt(this,ft,ge(t))}get current(){return G(this,ft).call(this),G(this,ht).call(this)}}ht=new WeakMap,ft=new WeakMap;var he=(l,n)=>e(n).reset(),fe=O('<fieldset><label class="row pt_xs"><input type="checkbox"> show bounding volume hierarchy</label></fieldset>'),ye=O('<div class="scene_controls svelte-1l7n56e"><button type="button" title="toggle the clock [Spacebar]"><div class="pr_sm">clock</div> <!></button> <button type="button" title="reset the scene [r]" class="plain">reset</button> <button type="button" class="plain deselectable">edit</button> <!></div> <!>',1);function Mn(l,n){$(n,!0);const t=U(()=>n.project.renderer),o=U(()=>n.project.scene),h=U(()=>e(o).clock),s=Ht.get();var r=ye(),_=J(r),a=D(_);a.__click=function(...x){var M;(M=e(h).toggle)==null||M.apply(this,x)},et(a,"min-width","105px");var c=N(D(a),2);te(c,{get running(){return e(h).running}}),R(a);var p=N(a,2);p.__click=[he,o];var w=N(p,2);w.__click=()=>s.editing=!s.editing;var y=N(w,2);dt(y,()=>n.children??Et),R(_);var b=N(_,2);{var k=x=>{var M=fe(),I=D(M),f=D(I);zt(f),rt(),R(I),R(M),ee(f,()=>e(t).show_bvh,Y=>e(t).show_bvh=Y),Gt(3,M,()=>Qt),X(x,M)};W(b,x=>{e(t).type==="canvas"&&x(k)})}q(()=>{Z(a,"color_d",e(h).running),H(w,"title",`${(s.editing?"stop editing":"start editing")??""} [~ Shift+Backtick]`),Z(w,"color_d",s.editing)}),X(l,r),Q()}st(["click"]);const me=new Tt(()=>window.innerWidth,l=>Kt(window,"resize",l)),pe=new Tt(()=>window.innerHeight,l=>Kt(window,"resize",l));var we=lt('<line class="svelte-4z6b3j"></line>'),xe=lt('<svg class="scrubbing_indicator svelte-4z6b3j" aria-hidden="true"><!></svg>');function vt(l,n){$(n,!0);const t=U(()=>n.container_width??me.current),o=U(()=>n.container_height??pe.current);ne(l,{to:document.body,children:(h,s)=>{var r=xe(),_=D(r);{var a=c=>{var p=we();q(()=>{H(p,"x1",n.x_start),H(p,"y1",n.y_start),H(p,"x2",n.x_last),H(p,"y2",n.y_last)}),X(c,p)};W(_,c=>{n.x_start!==null&&n.y_start!==null&&n.x_last!==null&&n.y_last!==null&&c(a)})}R(r),q(()=>{H(r,"viewBox",`0 0 ${e(t)??""} ${e(o)??""}`),H(r,"width",e(t)),H(r,"height",e(o))}),X(h,r)},$$slots:{default:!0}}),Q()}const be=(l,n)=>{l.ctrlKey||n(l.clientX,l.clientY)};var ke=O('<div class="title svelte-1emv8hj"><!></div>'),Se=O('<label role="slider"><!> <input></label> <!>',1);function In(l,n){$(n,!0);let t=tt(n,"value",15,0),o=tt(n,"type",3,"text"),h=tt(n,"inputmode",3,"numeric"),s=tt(n,"step",3,1),r=tt(n,"min",19,()=>1/0*-1),_=tt(n,"row",3,!1),a=m(d(t())),c=m(d(t().toString()));const p=K=>{var A;i(a,d(K)),t(Math.max(r(),K)),i(c,d(t().toString())),(A=n.oninput)==null||A.call(n,t())};Pt(()=>{t()!==Xt(()=>e(a))&&(i(a,d(t())),i(c,d(t().toString())))});const w=K=>{i(c,d(K));const A=parseFloat(K);Number.isNaN(A)||p(A)},y=K=>{p(e(a)+K)};let b=m(!1),k=m(null),x=m(null),M=m(null),I=m(null),f=m(null),Y=m(null),S=m(null);const u=U(()=>e(Y)===null||e(I)===null?null:e(Y)-e(I)),E=U(()=>e(S)===null||e(f)===null?null:e(f)-e(S)),z=U(()=>e(u)===null||e(E)===null?null:(e(u)+e(E))*s()),T=(K,A)=>{e(b)||(i(b,!0),i(k,d(t())),i(x,d(K)),i(M,d(A)),i(I,d(K)),i(f,d(A)))},F=()=>{i(b,!1),i(k,null),i(x,null),i(M,null),i(I,null),i(f,null),i(Y,null),i(S,null)},L=(K,A)=>{i(I,d(e(Y))),i(f,d(e(S))),i(Y,d(K)),i(S,d(A)),e(z)!==null&&y(e(z))},g=K=>{F()},v=K=>{F()},C=K=>{L(K.clientX,K.clientY)},P=K=>{K.key==="Escape"&&(p(e(k)),F(),it(K))};var B=Se();j("pointerup",V,function(...K){var A;(A=e(b)?g:void 0)==null||A.apply(this,K)}),j("pointermove",V,function(...K){var A;(A=e(b)?C:void 0)==null||A.apply(this,K)}),j("pointerleave",V,function(...K){var A;(A=e(b)?v:void 0)==null||A.apply(this,K)}),j("keydown",V,function(...K){var A;(A=e(b)?P:void 0)==null||A.apply(this,K)},!0);var ot=J(B);ot.__pointerdown=[be,T];var xt=D(ot);{var At=K=>{var A=ke(),Dt=D(A);dt(Dt,()=>n.children),R(A),X(K,A)};W(xt,K=>{n.children&&K(At)})}var bt=N(xt,2);zt(bt);var Nt=K=>w(K.currentTarget.value);let kt;R(ot);var qt=N(ot,2);{var Bt=K=>{vt(K,{get x_start(){return e(x)},get y_start(){return e(M)},get x_last(){return e(I)},get y_last(){return e(f)}})};W(qt,K=>{e(b)&&K(Bt)})}q(()=>{Ot(ot,`${n.classes??""} svelte-1emv8hj`),H(ot,"aria-valuenow",e(z)),H(ot,"title",n.title),Z(ot,"selected",e(b)),Z(ot,"row",_()),kt=Zt(bt,kt,{...n.attrs,class:n.input_classes,value:e(c),oninput:Nt,type:o(),inputmode:h(),step:s(),min:r(),max:n.max},"svelte-1emv8hj")}),X(l,B),Q()}st(["pointerdown"]);var Me=O('<div class="scene_renderer svelte-1hiky75"><!></div>');function Yn(l,n){$(n,!0);var t=Me(),o=D(t);{var h=s=>{var r=ct(),_=J(r);_e(_,()=>n.Component,(a,c)=>{c(a,{get scene(){return n.scene},get renderer(){return n.renderer}})}),X(s,r)};W(o,s=>{s(h)})}R(t),q(()=>{et(t,"width",`${n.renderer.width??""}px`),et(t,"height",`${n.renderer.height??""}px`),et(t,"min-width",`${n.renderer.width??""}px`),et(t,"min-height",`${n.renderer.height??""}px`)}),X(l,t),Q()}const Ie=(l,n)=>{n(l.clientX,l.clientY),it(l)};var Ye=lt('<polygon role="none" class="unit_circle_radius_handles svelte-1i5of7p" fill="var(--color_selected)"></polygon><!>',1);function Xe(l,n){$(n,!0);const t=tt(n,"unit",7),o=tt(n,"size",3,pt),h=.5;let s=m(!1),r=m(null),_=m(null),a=m(null),c=m(null),p=m(null),w=m(null),y=m(null);const b=U(()=>t().x),k=U(()=>t().y-Math.max(o(),t().radius*Math.abs(t().scale))),x=U(()=>o()/2),M=(g,v)=>{e(s)||(i(s,!0),i(r,d(t().radius)),i(_,d(g)),i(a,d(v)),i(c,d(g)),i(p,d(v)))},I=()=>{i(s,!1),i(r,null),i(_,null),i(a,null),i(c,null),i(p,null),i(w,null),i(y,null)},f=(g,v)=>{i(c,d(e(w))),i(p,d(e(y))),i(w,d(g)),i(y,d(v)),e(c)!==null&&e(p)!==null&&(t().radius=ie(e(r)+h*(e(w)-e(_)-(e(y)-e(a)))))},Y=g=>{I()},S=g=>{I()},u=g=>{f(g.clientX,g.clientY)},E=g=>{g.key==="Escape"&&(t().radius=e(r),I(),it(g))};var z=Ye();j("pointerup",V,function(...g){var v;(v=e(s)?Y:void 0)==null||v.apply(this,g)}),j("pointermove",V,function(...g){var v;(v=e(s)?u:void 0)==null||v.apply(this,g)}),j("pointerleave",V,function(...g){var v;(v=e(s)?S:void 0)==null||v.apply(this,g)}),j("keydown",V,function(...g){var v;(v=e(s)?E:void 0)==null||v.apply(this,g)},!0);var T=J(z);T.__pointerdown=[Ie,M];var F=N(T);{var L=g=>{vt(g,{get x_start(){return e(_)},get y_start(){return e(a)},get x_last(){return e(c)},get y_last(){return e(p)}})};W(F,g=>{e(s)&&g(L)})}q(()=>{H(T,"points",`${e(b)-e(x)},${e(k)-e(x)} ${e(b)+e(x)},${e(k)-e(x)} ${e(b)??""},${e(k)+e(x)}`),Z(T,"pressing",e(s))}),X(l,z),Q()}st(["pointerdown"]);const Ee=(l,n)=>{n(l.clientX,l.clientY),it(l)};var Pe=lt('<circle role="none" class="unit_scale_handles svelte-rpawlp" fill="var(--color_selected)"></circle><!>',1);function jt(l,n){$(n,!0);const t=tt(n,"unit",7),o=tt(n,"size",3,pt),h=.01;let s=m(!1),r=m(null),_=m(null),a=m(null),c=m(null),p=m(null),w=m(null),y=m(null),b=m(null),k=m(null);const x=U(()=>t().scene.controller.pressing_alt?"move":"nesw-resize"),M=(g,v)=>{e(s)||(i(s,!0),i(r,d(t().scale)),i(_,d(t().x)),i(a,d(t().y)),i(c,d(g)),i(p,d(v)),i(w,d(g)),i(y,d(v)))},I=()=>{i(s,!1),i(r,null),i(_,null),i(a,null),i(c,null),i(p,null),i(w,null),i(y,null),i(b,null),i(k,null)},f=(g,v)=>{i(w,d(e(b))),i(y,d(e(k))),i(b,d(g)),i(k,d(v)),e(w)!==null&&e(y)!==null&&(t().scene.controller.pressing_alt?t().move_center_to(t().x+(e(b)-e(w)),t().y+(e(k)-e(y))):t().scale=le(e(r)+h*(e(b)-e(c)-(e(k)-e(p)))))},Y=g=>{I()},S=g=>{I()},u=g=>{f(g.clientX,g.clientY)},E=g=>{g.key==="Escape"&&(t().scene.controller.pressing_alt?t().move_center_to(e(_),e(a)):t().scale=e(r),I(),it(g))};var z=Pe();j("pointerup",V,function(...g){var v;(v=e(s)?Y:void 0)==null||v.apply(this,g)}),j("pointermove",V,function(...g){var v;(v=e(s)?u:void 0)==null||v.apply(this,g)}),j("pointerleave",V,function(...g){var v;(v=e(s)?S:void 0)==null||v.apply(this,g)}),j("keydown",V,function(...g){var v;(v=e(s)?E:void 0)==null||v.apply(this,g)},!0);var T=J(z);T.__pointerdown=[Ee,M];var F=N(T);{var L=g=>{vt(g,{get x_start(){return e(c)},get y_start(){return e(p)},get x_last(){return e(w)},get y_last(){return e(y)}})};W(F,g=>{e(s)&&g(L)})}q(()=>{H(T,"cx",t().x),H(T,"cy",t().y),H(T,"r",o()/2),Z(T,"pressing",e(s)),et(T,"cursor",e(x))}),X(l,z),Q()}st(["pointerdown"]);var Ke=O("<!> <!>",1);function ze(l,n){var t=Ke(),o=J(t);jt(o,{get unit(){return n.unit}});var h=N(o,2);Xe(h,{get unit(){return n.unit}}),X(l,t)}const Ce=(l,n)=>{n(l.clientX,l.clientY),it(l)};var He=lt('<polygon role="none" class="unit_polygon_point_handles svelte-1fl6mbc" fill="var(--color_selected)"></polygon><!>',1);function Ue(l,n){$(n,!0);const t=tt(n,"size",3,pt);let o=m(!1),h=m(null),s=m(null),r=m(null),_=m(null),a=m(null),c=m(null),p=m(null),w=m(null),y=m(d(n.point));const b=U(()=>n.unit.x+n.transformed_point.x),k=U(()=>n.unit.y+n.transformed_point.y),x=U(()=>t()/2),M=U(()=>n.unit.scene.controller.pressing_ctrl&&n.unit.scene.controller.pressing_alt?"no-drop":n.unit.scene.controller.pressing_alt?n.unit.scene.controller.pressing_shift?"alias":"copy":"move"),I=(v,C)=>{if(n.unit.scene.controller.pressing_ctrl&&n.unit.scene.controller.pressing_alt){n.unit.points.length>3&&n.unit.remove_point(n.point);return}e(o)||(i(o,!0),n.unit.scene.controller.pressing_alt?i(y,d(n.unit.duplicate_point(n.point,n.unit.scene.controller.pressing_shift))):i(y,d(n.point)),i(h,d(e(y).x)),i(s,d(e(y).y)),i(r,d(v)),i(_,d(C)),i(a,d(v)),i(c,d(C)))},f=()=>{i(o,!1),i(h,null),i(s,null),i(r,null),i(_,null),i(a,null),i(c,null),i(p,null),i(w,null),i(y,d(n.point))},Y=(v,C)=>{i(a,d(e(p))),i(c,d(e(w))),i(p,d(v)),i(w,d(C)),e(a)!==null&&e(c)!==null&&n.unit.move_transformed_point(e(y),e(p)-e(a),e(w)-e(c))},S=v=>{f()},u=v=>{f()},E=v=>{Y(v.clientX,v.clientY)},z=v=>{v.key==="Escape"&&(n.unit.scene.controller.pressing_alt&&e(y)!==n.point?n.unit.remove_point(e(y)):(e(y).x=e(h),e(y).y=e(s),n.unit.update_points()),f(),it(v))};var T=He();j("pointerup",V,function(...v){var C;(C=e(o)?S:void 0)==null||C.apply(this,v)}),j("pointermove",V,function(...v){var C;(C=e(o)?E:void 0)==null||C.apply(this,v)}),j("pointerleave",V,function(...v){var C;(C=e(o)?u:void 0)==null||C.apply(this,v)}),j("keydown",V,function(...v){var C;(C=e(o)?z:void 0)==null||C.apply(this,v)},!0);var F=J(T);F.__pointerdown=[Ce,I];var L=N(F);{var g=v=>{vt(v,{get x_start(){return e(r)},get y_start(){return e(_)},get x_last(){return e(a)},get y_last(){return e(c)}})};W(L,v=>{e(o)&&v(g)})}q(()=>{H(F,"points",`${e(b)-e(x)},${e(k)-e(x)} ${e(b)+e(x)},${e(k)-e(x)} ${e(b)??""},${e(k)+e(x)}`),Z(F,"pressing",e(o)),et(F,"cursor",e(M))}),X(l,T),Q()}st(["pointerdown"]);const Te=(l,n)=>{n(l.clientX,l.clientY),it(l)};var je=lt('<polygon role="none" class="unit_polygon_rotation_handles svelte-tnupuo" fill="var(--color_selected)"></polygon><!>',1);function Ae(l,n){$(n,!0);const t=tt(n,"unit",7),o=tt(n,"size",3,pt),h=.013;let s=m(!1),r=m(null),_=m(null),a=m(null),c=m(null),p=m(null),w=m(null),y=m(null),b=m(null),k=m(null);const x=U(()=>t().scene.controller.pressing_alt?"move":"ew-resize"),M=U(()=>t().x+o()*Math.cos(-1*(t().rotation-Math.PI/2))),I=U(()=>t().y-o()*Math.sin(-1*(t().rotation-Math.PI/2))),f=U(()=>`${e(M)},${e(I)-o()/2} ${e(M)+o()/3},${e(I)} ${e(M)},${e(I)+o()/2} ${e(M)-o()/3},${e(I)}`),Y=(P,B)=>{e(s)||(i(s,!0),i(r,d(t().rotation)),i(_,d(t().x)),i(a,d(t().y)),i(c,d(P)),i(p,d(B)),i(w,d(P)),i(y,d(B)))},S=()=>{i(s,!1),i(r,null),i(c,null),i(p,null),i(w,null),i(y,null),i(b,null),i(k,null)},u=(P,B)=>{i(w,d(e(b))),i(y,d(e(k))),i(b,d(P)),i(k,d(B)),e(w)!==null&&e(y)!==null&&(t().scene.controller.pressing_alt?t().move_center_to(t().x+(e(b)-e(w)),t().y+(e(k)-e(y))):t().rotation=oe(e(r)+h*(e(b)-e(c)-(e(k)-e(p)))))},E=P=>{S()},z=P=>{S()},T=P=>{u(P.clientX,P.clientY)},F=P=>{P.key==="Escape"&&(t().scene.controller.pressing_alt?t().move_center_to(e(_),e(a)):t().rotation=e(r),S(),it(P))};var L=je();j("pointerup",V,function(...P){var B;(B=e(s)?E:void 0)==null||B.apply(this,P)}),j("pointermove",V,function(...P){var B;(B=e(s)?T:void 0)==null||B.apply(this,P)}),j("pointerleave",V,function(...P){var B;(B=e(s)?z:void 0)==null||B.apply(this,P)}),j("keydown",V,function(...P){var B;(B=e(s)?F:void 0)==null||B.apply(this,P)},!0);var g=J(L);g.__pointerdown=[Te,Y];var v=N(g);{var C=P=>{vt(P,{get x_start(){return e(c)},get y_start(){return e(p)},get x_last(){return e(w)},get y_last(){return e(y)}})};W(v,P=>{e(s)&&P(C)})}q(()=>{H(g,"points",e(f)),H(g,"transform",`rotate(${t().rotation_degrees??""} ${e(M)??""} ${e(I)??""})`),Z(g,"pressing",e(s)),et(g,"cursor",e(x))}),X(l,L),Q()}st(["pointerdown"]);var Ne=O("<!> <!> <!>",1);function qe(l,n){$(n,!0);var t=Ne(),o=J(t);Ct(o,18,()=>n.unit.points,r=>r,(r,_,a)=>{Ue(r,{get unit(){return n.unit},get point(){return _},get transformed_point(){return n.unit.transformed_points[e(a)]}})});var h=N(o,2);jt(h,{get unit(){return n.unit}});var s=N(h,2);Ae(s,{get unit(){return n.unit}}),X(l,t),Q()}function Be(l,n){$(n,!0);const t=U(()=>n.unit.type);var o=ct(),h=J(o);{var s=_=>{ze(_,{get unit(){return n.unit}})},r=_=>{var a=ct(),c=J(a);{var p=y=>{qe(y,{get unit(){return n.unit}})},w=y=>{var b=at();q(()=>gt(b,Ut(e(t)))),X(y,b)};W(c,y=>{e(t)==="polygon"?y(p):y(w,!1)},!0)}X(_,a)};W(h,_=>{e(t)==="circle"?_(s):_(r,!1)})}X(l,o),Q()}var De=O('<menu class="pane unstyled svelte-pa2qv7"><!></menu>'),Re=O('<li role="none" class="svelte-pa2qv7"><div class="menu_item plain selectable svelte-pa2qv7" role="menuitem" aria-label="contextmenu submenmu" tabindex="-1"><div class="content"><div class="icon"><!></div> <div class="title"><!></div></div> <div class="chevron svelte-pa2qv7" aria-hidden="true"></div></div> <!></li>');function Ve(l,n){$(n,!0);const t=re.get(),o=t.add_submenu(),{layout:h}=t,s=U(()=>o.selected);let r=m(void 0);const _=Yt.get(),a=Yt.set();let c=m(0),p=m(0);Pt(()=>{e(r)&&w(e(r),h,_)});const w=(u,E,z)=>{const{x:T,y:F,width:L,height:g}=u.getBoundingClientRect();a.width=L,a.height=g;const v=T-e(c),C=F-e(p),P=v+L+z.width-E.width;if(P<=0)i(c,d(z.width));else{const B=L-v;B<=0?i(c,-L):B>P?i(c,z.width-P):i(c,B-L)}i(p,d(Math.min(0,E.height-(C+g))))};var y=Re(),b=D(y),k=D(b),x=D(k),M=D(x);dt(M,()=>n.icon??Et),R(x);var I=N(x,2),f=D(I);dt(f,()=>n.children),R(I),R(k),rt(2),R(b);var Y=N(b,2);{var S=u=>{var E=De(),z=D(E);dt(z,()=>n.menu),R(E),ve(E,T=>i(r,T),()=>e(r)),q(()=>{et(E,"transform",`translate3d(${e(c)??""}px, ${e(p)??""}px, 0)`),et(E,"max-height",`${h.height??""}px`)}),X(u,E)};W(Y,u=>{e(s)&&u(S)})}R(y),q(()=>{et(y,"--contextmenu_depth",o.depth),H(b,"aria-expanded",e(s)),Z(b,"selected",e(s))}),j("mouseenter",b,u=>{it(u),setTimeout(()=>t.select(o))}),X(l,y),Q()}var We=lt('<circle role="none"></circle>'),Fe=lt('<polygon role="none"></polygon>'),Le=lt('<svg class="unit_icon svelte-yrh1le"><!></svg>');function Je(l,n){$(n,!0);const t=tt(n,"padding",3,2),o=U(()=>n.unit.type),h=U(()=>n.unit.points),s=U(()=>n.unit.rotation),r=100,_=r/2,a=U(()=>`rotate(${e(s)*360/(Math.PI*2)} ${_} ${_})`),c=U(()=>{if(e(o)!=="polygon"||!e(h).length)return"";const k=e(h).map(E=>E.x),x=e(h).map(E=>E.y),M=(Math.min(...k)+Math.max(...k))/2,I=(Math.min(...x)+Math.max(...x))/2,f=Math.max(...e(h).map(E=>Math.sqrt((E.x-M)**2+(E.y-I)**2))),Y=(r-t()*2)/(f*2),S=r/2-M*Y,u=r/2-I*Y;return e(h).map(E=>`${E.x*Y+S},${E.y*Y+u}`).join(" ")});var p=Le();H(p,"viewBox",`0 0 ${r} ${r}`);var w=D(p);{var y=k=>{var x=We();H(x,"cx",_),H(x,"cy",_),q(()=>{H(x,"r",(r-t()*2)/2.6),H(x,"fill",n.unit.color),H(x,"transform",e(a))}),X(k,x)},b=k=>{var x=ct(),M=J(x);{var I=Y=>{var S=Fe();q(()=>{H(S,"points",e(c)),H(S,"fill",n.unit.color),H(S,"transform",e(a))}),X(Y,S)},f=Y=>{var S=at();q(()=>gt(S,Ut(e(o)))),X(Y,S)};W(M,Y=>{e(o)==="polygon"?Y(I):Y(f,!1)},!0)}X(k,x)};W(w,k=>{e(o)==="circle"?k(y):k(b,!1)})}R(p),X(l,p),Q()}var Oe=O("<!> <!> <!> <!>",1),Ze=O("<small><code> </code></small>"),Ge=O("Unit <!>",1),Qe=O('<div class="display_contents"><!></div>');function $e(l,n){$(n,!0);const t=_=>{var a=ct(),c=J(a);{var p=w=>{Ve(w,{menu:k=>{var x=Oe(),M=J(x);mt(M,{icon:"⎘",run:()=>{const u=n.unit.clone();u.x+=10,u.y+=10,n.scene.add_unit(u)},children:(u,E)=>{rt();var z=at("Duplicate unit");X(u,z)},$$slots:{default:!0}});var I=N(M,2);{var f=u=>{mt(u,{icon:"◎",run:()=>{n.unit.create_new_point()},children:(E,z)=>{rt();var T=at("Add point to polygon");X(E,T)},$$slots:{default:!0}})};W(I,u=>{n.unit.type==="polygon"&&u(f)})}var Y=N(I,2);mt(Y,{icon:"⌸",run:async()=>{const u=JSON.stringify(n.unit.json);await navigator.clipboard.writeText(u)},children:(u,E)=>{rt();var z=at("Copy data to clipboard");X(u,z)},$$slots:{default:!0}});var S=N(Y,2);mt(S,{icon:"✕",run:()=>{n.scene.remove_unit(n.unit)},children:(u,E)=>{rt();var z=at("Delete unit");X(u,z)},$$slots:{default:!0}}),X(k,x)},icon:k=>{Je(k,{get unit(){return n.unit}})},children:(k,x)=>{rt();var M=Ge(),I=N(J(M));{var f=S=>{var u=at();q(()=>gt(u,n.unit.name)),X(S,u)},Y=S=>{var u=Ze(),E=D(u),z=D(E,!0);R(E),R(u),q(()=>gt(z,n.unit.id_string)),X(S,u)};W(I,S=>{n.unit.name?S(f):S(Y,!1)})}X(k,M)},$$slots:{menu:!0,icon:!0,default:!0}})};W(c,w=>{n.unit&&w(p)})}X(_,a)};var o=ct(),h=J(o);{var s=_=>{var a=Qe(),c=D(a);dt(c,()=>n.children),R(a),se(a,(p,w)=>{var y;return(y=ae)==null?void 0:y(p,w)},()=>t),q(()=>H(a,"data-unit",n.unit.id)),X(_,a)},r=_=>{var a=ct(),c=J(a);dt(c,()=>n.children),X(_,a)};W(h,_=>{n.unit?_(s):_(r,!1)})}X(l,o),Q()}const tn=()=>({selecting:!1,selection_start_x:0,selection_start_y:0,selection_width:0,selection_height:0,initial_pointer_x:0,initial_pointer_y:0});var yt,nt,ut;class en{constructor(n){Mt(this,"selection_threshold",0);_t(this,yt,m(d(tn())));_t(this,nt,m(d(new Set)));_t(this,ut,m(d(new Set)));this.helpers=n}get state(){return e(G(this,yt))}set state(n){i(G(this,yt),d(n))}has(n){return e(G(this,nt)).has(n)}add(n){e(G(this,nt)).add(n)}delete(n){e(G(this,nt)).delete(n)}clear(){e(G(this,nt)).clear()}get_selected_items(){return Array.from(e(G(this,nt)))}handle_selection_start(n,t,o){const h=this.helpers.find_top_item(n,t),s=h&&this.has(h);if(this.state.initial_pointer_x=n,this.state.initial_pointer_y=t,i(G(this,ut),d(new Set(e(G(this,nt))))),o==="subtractive"&&s){this.delete(h);return}h&&o!=="subtractive"?(o==="normal"&&this.clear(),this.add(h)):o==="normal"&&this.clear()}start_drag(n,t){this.state.selecting=!0,this.state.selection_start_x=n,this.state.selection_start_y=t,this.state.selection_width=0,this.state.selection_height=0}update_drag(n,t,o){if(!this.state.selecting)return;this.state.selection_width=n-this.state.selection_start_x,this.state.selection_height=t-this.state.selection_start_y;const h=this.state.selection_width>=0?this.state.selection_start_x:n,s=this.state.selection_height>=0?this.state.selection_start_y:t,r=Math.abs(this.state.selection_width),_=Math.abs(this.state.selection_height),a=this.helpers.find_all_items(h,s,r,_);switch(o){case"additive":i(G(this,nt),d(new Set(e(G(this,ut)))));for(const c of a)this.add(c);break;case"subtractive":i(G(this,nt),d(new Set(e(G(this,ut)))));for(const c of a)this.delete(c);break;case"normal":this.clear();for(const c of a)this.add(c);break;default:throw new ue(o)}}end_drag(n,t,o){const h=n-this.state.initial_pointer_x,s=t-this.state.initial_pointer_y,r=Math.sqrt(h*h+s*s)>this.selection_threshold;this.state.selecting&&r&&this.update_drag(n,t,o),this.state.selecting=!1,this.state.selection_width=0,this.state.selection_height=0,e(G(this,ut)).clear()}}yt=new WeakMap,nt=new WeakMap,ut=new WeakMap;const nn=(l,n,t,o,h,s,r,_)=>{n(l.offsetX,l.offsetY),t(t().pointer_down=!0,!0),t(t().drag_start_x=t().pointer_x,!0),t(t().drag_start_y=t().pointer_y,!0),t(t().drag_start_client_x=t(t().pointer_last_client_x=l.clientX,!0),!0),t(t().drag_start_client_y=t(t().pointer_last_client_y=l.clientY,!0),!0);const a=l.shiftKey&&l.ctrlKey&&!l.altKey;if(t().hovering_handle){!l.altKey&&l.shiftKey&&t().hovering_unit&&(t(t().dragging_unit=t().hovering_unit,!0),t(t().dragging_selection=!0,!0),o.unit_selection.has(t().hovering_unit)||((!l.ctrlKey||a)&&o.unit_selection.clear(),o.unit_selection.add(t().hovering_unit)),a&&e(h)&&s());return}const c=t().hovering_unit;if(c&&o.unit_selection.has(c)&&(l.shiftKey&&!l.altKey||!l.ctrlKey)){t(t().dragging_unit=c,!0),t(t().dragging_selection=!0,!0),a&&e(h)&&s();return}r.handle_selection_start(t().pointer_x,t().pointer_y,_(l)),o.unit_selection.clear();for(const w of r.get_selected_items())o.unit_selection.add(w)},ln=(l,n,t,o,h,s,r)=>{if(n(l.offsetX,l.offsetY),t.state.selecting){t.end_drag(o().pointer_x,o().pointer_y,h(l)),s.unit_selection.clear();for(const _ of t.get_selected_items())s.unit_selection.add(_)}r()},on=(l,n,t,o,h,s)=>{if(n(l.offsetX,l.offsetY),t(t().pointer_last_client_x=l.clientX,!0),t(t().pointer_last_client_y=l.clientY,!0),t().pointer_down&&!t().dragging_unit){const r=t().pointer_x-o.state.initial_pointer_x,_=t().pointer_y-o.state.initial_pointer_y;Math.sqrt(r*r+_*_)>o.selection_threshold&&!o.state.selecting&&o.start_drag(o.state.initial_pointer_x,o.state.initial_pointer_y)}if(o.state.selecting){o.update_drag(t().pointer_x,t().pointer_y,h(l)),s.unit_selection.clear();for(const r of o.get_selected_items())s.unit_selection.add(r)}};var rn=lt('<rect class="selection_rect svelte-1s96klh"></rect>'),sn=O('<div class="scene_interaction_surface svelte-1s96klh"><svg class="controls_layer svelte-1s96klh"><!><!></svg></div> <!>',1);function Xn(l,n){$(n,!0);const t=tt(n,"scene_interaction_surface_state",15),o=U(()=>n.scene.controller),h=f=>f,s=f=>f,r=new en({find_top_item:n.scene.find_top_unit_at_point,find_all_items:n.scene.find_all_units_in_rect}),_=f=>f.shiftKey&&f.ctrlKey?"additive":f.ctrlKey?"subtractive":f.shiftKey?"additive":"normal",a=U(()=>t().hovering_unit!==null&&n.unit_selection.has(t().hovering_unit)),c=(f,Y)=>{const S=h(f),u=s(Y),E=t().pointer_x,z=t().pointer_y;if(t(t().pointer_x=S,!0),t(t().pointer_y=u,!0),t().dragging_unit){const T=S-E,F=u-z;for(const L of n.unit_selection)L.x+=T,L.y+=F}else t(t().hovering_unit=n.scene.find_top_unit_at_point(S,u),!0),t().hovering_unit&&t(t().hovered_unit=t().hovering_unit,!0)},p=()=>{t(t().pointer_down=!1,!0),t(t().drag_start_x=null,!0),t(t().drag_start_y=null,!0),t(t().dragging_unit=null,!0),t(t().dragging_selection=!1,!0),t(t().drag_start_client_x=null,!0),t(t().drag_start_client_y=null,!0),t(t().pointer_last_client_x=null,!0),t(t().pointer_last_client_y=null,!0)},w=()=>{const f=[];for(const Y of n.unit_selection){const S=Y.clone();n.scene.add_unit(S),f.push(S)}n.unit_selection.clear(),r.clear();for(const Y of f)n.unit_selection.add(Y),r.add(Y)},y=f=>{c(f.offsetX,f.offsetY),t(t().pointing=!0,!0)},b=f=>{c(f.offsetX,f.offsetY),t(t().pointing=!1,!0),t(t().hovering_unit=null,!0)},k=f=>{t().pointer_down&&t(t().pointer_down=!1,!0),t(t().dragging_unit=null,!0),t(t().dragging_selection=!1,!0)},x=f=>{(f.key==="Shift"||f.key==="Control")&&r.update_drag(t().pointer_x,t().pointer_y,_(f))},M=f=>{(f.key==="Shift"||f.key==="Control")&&r.update_drag(t().pointer_x,t().pointer_y,_(f))},I=f=>{if(f.key==="Escape"&&t().dragging_unit){const Y=t().pointer_x-t().drag_start_x,S=t().pointer_y-t().drag_start_y;for(const u of n.unit_selection)u.x-=Y,u.y-=S;p(),it(f)}};j("keydown",V,x),j("keyup",V,M),j("keydown",V,I,!0),$e(l,{get scene(){return n.scene},get unit(){return t().hovered_unit},children:(f,Y)=>{var S=sn(),u=J(S);u.__pointerdown=[nn,c,t,n,a,w,r,_],u.__pointerup=[ln,c,r,t,_,n,p],u.__pointermove=[on,c,t,r,_,n];const E=U(()=>t().hovering_unit&&n.unit_selection.has(t().hovering_unit)&&!r.state.selecting&&!t().pointer_down);q(()=>Z(u,"grabbable",e(E)));var z=D(u),T=D(z);Ct(T,16,()=>Array.from(n.unit_selection),C=>C,(C,P)=>{Be(C,{get unit(){return P}})});var F=N(T);{var L=C=>{var P=rn();q(()=>H(P,"width",Math.abs(r.state.selection_width))),q(()=>H(P,"height",Math.abs(r.state.selection_height))),q(()=>{H(P,"x",r.state.selection_width>=0?r.state.selection_start_x:r.state.selection_start_x+r.state.selection_width),H(P,"y",r.state.selection_height>=0?r.state.selection_start_y:r.state.selection_start_y+r.state.selection_height)}),X(C,P)};W(F,C=>{r.state.selecting&&C(L)})}R(z),R(u);var g=N(u,2);{var v=C=>{vt(C,{get x_start(){return t().drag_start_client_x},get y_start(){return t().drag_start_client_y},get x_last(){return t().pointer_last_client_x},get y_last(){return t().pointer_last_client_y}})};W(g,C=>{t().dragging_unit&&C(v)})}q(()=>{Z(u,"pressing",t().pointer_down),Z(u,"selecting",r.state.selecting),Z(u,"hovering",!!t().hovering_unit),Z(u,"hovering_selection",e(a)),Z(u,"grabbing",t().dragging_unit!==null),Z(u,"pressing_shift",e(o).pressing_shift),Z(u,"pressing_ctrl",e(o).pressing_ctrl),Z(u,"pressing_alt",e(o).pressing_alt),et(u,"width",`${n.width??""}px`),et(u,"height",`${n.height??""}px`),H(z,"width",n.width),H(z,"height",n.height)}),j("pointerenter",u,y),j("pointerleave",u,b),j("pointercancel",u,k),X(f,S)},$$slots:{default:!0}}),Q()}st(["pointerdown","pointerup","pointermove"]);var an=O('<div class="flex align_items_end font_weight_700 px_md font_mono"><div class="text_align_right pr_xs"> </div> <div class="text_color_4">fps</div></div>');function En(l,n){$(n,!0);const t=U(()=>n.clock??ce.get());var o=an(),h=D(o);et(h,"width","4rem");var s=D(h,!0);R(h),rt(2),R(o),q(()=>gt(s,e(t).average_fps)),X(l,o),Q()}var un=(l,n)=>i(n,!0),cn=O("<p><strong>WASD</strong> and <strong>arrow keys</strong> to move the player</p>"),dn=O("<p><strong>` Backtick</strong> to toggle playing</p>"),_n=O('<div class="content pane svelte-1487nr8"><h2 class="mt_0">Global controls</h2> <!> <p><strong>r</strong> to reset</p> <p><strong>spacebar</strong> to toggle the clock</p> <!> <p><strong>~ Shift+Backtick</strong> to toggle editing</p> <p>edit with mouse and <strong>Ctrl</strong>/<strong>Shift</strong>/<strong>Alt</strong>:</p> <ul><li><strong>Shift</strong> to add to selection</li> <li><strong>Ctrl</strong> to remove from selection</li> <li><strong>Shift+Ctrl</strong> to duplicate the selected units</li> <li><strong>Alt</strong> to recenter polygons</li> <li><strong>Alt</strong> to duplicate points</li> <li><strong>Alt+Shift</strong> to duplicate points counterclockwise</li></ul></div>'),vn=O('<button type="button">help</button> <!>',1);function Pn(l,n){$(n,!0);const t=Ht.get();let o=m(!1);var h=vn(),s=J(h);s.__click=[un,o];var r=N(s,2);{var _=a=>{de(a,{onclose:()=>i(o,!1),children:(c,p)=>{var w=_n(),y=N(D(w),2);{var b=M=>{var I=cn();X(M,I)};W(y,M=>{t.player_input_enabled&&M(b)})}var k=N(y,6);{var x=M=>{var I=dn();X(M,I)};W(k,M=>{t.player_input_enabled&&M(x)})}rt(6),R(w),X(c,w)},$$slots:{default:!0}})};W(r,a=>{e(o)&&a(_)})}X(l,h),Q()}st(["click"]);export{En as F,Pn as H,Mn as S,Je as U,Yn as a,Xn as b,In as c,$e as d};
