var Rt=Object.defineProperty;var Mt=l=>{throw TypeError(l)};var Vt=(l,n,t)=>n in l?Rt(l,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[n]=t;var Yt=(l,n,t)=>Vt(l,typeof n!="symbol"?n+"":n,t),Et=(l,n,t)=>n.has(l)||Mt("Cannot "+t);var $=(l,n,t)=>(Et(l,n,"read from private field"),t?t.call(l):n.get(l)),vt=(l,n,t)=>n.has(l)?Mt("Cannot add the same private member more than once"):n instanceof WeakSet?n.add(l):n.set(l,t),St=(l,n,t,o)=>(Et(l,n,"write to private field"),o?o.call(l,t):n.set(l,t),t);import{a as P,t as J,n as rt,c as _t,b as ut}from"./disclose-version.Ds06f9Vu.js";import{aJ as Wt,K as e,k as Lt,j as Xt,a1 as Ft,a4 as Ot,v as Z,m as B,o as tt,q as et,L as T,c as R,s as q,D as Ct,r as V,n as st,a0 as f,u as zt,W as i,aI as W}from"./runtime.5k9ShzZt.js";import{d as at,o as Kt,k as A,s as ht}from"./render.CAjsxhF5.js";import{i as L,p as nt,c as u}from"./props.lofZ2jro.js";import{s as dt}from"./snippet.CcawutmI.js";import{b as it,r as Ht,t as G,s as H,g as Zt,k as Jt,a as Gt,e as Tt}from"./string.D4Ftlgln.js";import{t as Qt,s as $t}from"./index.DteDSzYE.js";import{ap as te,e as Ut,P as ee,u as ne,aq as ie,I as lt,ar as xt,as as le,at as oe,au as re,av as se,aw as At,y as ae,A as Pt,B as ue,Y as ce,z as wt,ax as _e,Z as de,c as ve,a1 as ge}from"./renderer_components.Cmt3dLGU.js";import{c as he}from"./svelte-component.BgFhLqea.js";import{b as fe}from"./preload-helper.DV2ohNv5.js";function ye(l){let n=0,t=Ot(0),o;return()=>{Wt()&&(e(t),Lt(()=>(n===0&&(o=Xt(()=>l(()=>te(t)))),n+=1,()=>{Ft().then(()=>{n-=1,n===0&&(o==null||o(),o=void 0)})})))}}var ft,yt;class jt{constructor(n,t){vt(this,ft);vt(this,yt);St(this,ft,n),St(this,yt,ye(t))}get current(){return $(this,yt).call(this),$(this,ft).call(this)}}ft=new WeakMap,yt=new WeakMap;var me=(l,n)=>e(n).reset(),pe=J('<fieldset><label class="row pt_xs"><input type="checkbox"> show bounding volume hierarchy</label></fieldset>'),we=J('<div class="scene_controls svelte-1l7n56e"><button type="button" title="toggle the clock [Spacebar]"><div class="pr_sm">clock</div> <!></button> <button type="button" title="reset the scene [r]" class="plain">reset</button> <button type="button" class="plain deselectable">edit</button> <!></div> <!>',1);function En(l,n){et(n,!0);const t=T(()=>n.project.renderer),o=T(()=>n.project.scene),h=T(()=>e(o).clock),s=Ut.get();var r=we(),d=Z(r),a=R(d);a.__click=function(...b){var M;(M=e(h).toggle)==null||M.apply(this,b)},it(a,"min-width","105px");var c=q(R(a),2);ee(c,{get running(){return e(h).running}}),V(a);var m=q(a,2);m.__click=[me,o];var p=q(m,2);p.__click=()=>s.editing=!s.editing;var y=q(p,2);dt(y,()=>n.children??Ct),V(d);var x=q(d,2);{var S=b=>{var M=pe(),Y=R(M),v=R(Y);Ht(v),st(),V(Y),V(M),ne(v,()=>e(t).show_bvh,k=>e(t).show_bvh=k),Qt(3,M,()=>$t),P(b,M)};L(x,b=>{e(t).type==="canvas"&&b(S)})}B(()=>{G(a,"color_d",e(h).running),H(p,"title",`${(s.editing?"stop editing":"start editing")??""} [~ Shift+Backtick]`),G(p,"color_d",s.editing)}),P(l,r),tt()}at(["click"]);const xe=new jt(()=>window.innerWidth,l=>Kt(window,"resize",l)),be=new jt(()=>window.innerHeight,l=>Kt(window,"resize",l));var ke=rt('<line class="svelte-4z6b3j"></line>'),Se=rt('<svg class="scrubbing_indicator svelte-4z6b3j" aria-hidden="true"><!></svg>');function gt(l,n){et(n,!0);const t=T(()=>n.container_width??xe.current),o=T(()=>n.container_height??be.current);ie(l,{to:document.body,children:(h,s)=>{var r=Se(),d=R(r);{var a=c=>{var m=ke();B(()=>{H(m,"x1",n.x_start),H(m,"y1",n.y_start),H(m,"x2",n.x_last),H(m,"y2",n.y_last)}),P(c,m)};L(d,c=>{n.x_start!==null&&n.y_start!==null&&n.x_last!==null&&n.y_last!==null&&c(a)})}V(r),B(()=>{H(r,"viewBox",`0 0 ${e(t)??""} ${e(o)??""}`),H(r,"width",e(t)),H(r,"height",e(o))}),P(h,r)},$$slots:{default:!0}}),tt()}const Ie=(l,n)=>{l.ctrlKey||n(l.clientX,l.clientY)};var Me=J('<div class="title svelte-1emv8hj"><!></div>'),Ye=J('<label role="slider"><!> <input></label> <!>',1);function Pn(l,n){et(n,!0);let t=nt(n,"value",15,0),o=nt(n,"type",3,"text"),h=nt(n,"inputmode",3,"numeric"),s=nt(n,"step",3,1),r=nt(n,"min",19,()=>1/0*-1),d=nt(n,"row",3,!1),a=f(u(t())),c=f(u(t().toString()));const m=C=>{var j;i(a,u(C)),t(Math.max(r(),C)),i(c,u(t().toString())),(j=n.oninput)==null||j.call(n,t())};zt(()=>{t()!==Xt(()=>e(a))&&(i(a,u(t())),i(c,u(t().toString())))});const p=C=>{i(c,u(C));const j=parseFloat(C);Number.isNaN(j)||m(j)},y=C=>{m(e(a)+C)};let x=f(!1),S=f(null),b=f(null),M=f(null),Y=f(null),v=f(null),k=f(null),w=f(null);const _=T(()=>e(k)===null||e(Y)===null?null:e(k)-e(Y)),I=T(()=>e(w)===null||e(v)===null?null:e(v)-e(w)),K=T(()=>e(_)===null||e(I)===null?null:(e(_)+e(I))*s()),U=(C,j)=>{e(x)||(i(x,!0),i(S,u(t())),i(b,u(C)),i(M,u(j)),i(Y,u(C)),i(v,u(j)))},Q=()=>{i(x,!1),i(S,null),i(b,null),i(M,null),i(Y,null),i(v,null),i(k,null),i(w,null)},O=(C,j)=>{i(Y,u(e(k))),i(v,u(e(w))),i(k,u(C)),i(w,u(j)),e(K)!==null&&y(e(K))},g=C=>{Q()},E=C=>{Q()},N=C=>{O(C.clientX,C.clientY)},X=C=>{C.key==="Escape"&&(m(e(S)),Q(),lt(C))};var D=Ye();A("pointerup",W,function(...C){var j;(j=e(x)?g:void 0)==null||j.apply(this,C)}),A("pointermove",W,function(...C){var j;(j=e(x)?N:void 0)==null||j.apply(this,C)}),A("pointerleave",W,function(...C){var j;(j=e(x)?E:void 0)==null||j.apply(this,C)}),A("keydown",W,function(...C){var j;(j=e(x)?X:void 0)==null||j.apply(this,C)},!0);var z=Z(D);z.__pointerdown=[Ie,U];var F=R(z);{var bt=C=>{var j=Me(),Nt=R(j);dt(Nt,()=>n.children),V(j),P(C,j)};L(F,C=>{n.children&&C(bt)})}var pt=q(F,2);Ht(pt);var kt=C=>p(C.currentTarget.value);let It;V(z);var qt=q(z,2);{var Bt=C=>{gt(C,{get x_start(){return e(b)},get y_start(){return e(M)},get x_last(){return e(Y)},get y_last(){return e(v)}})};L(qt,C=>{e(x)&&C(Bt)})}B(()=>{Zt(z,Jt(n.classes),"svelte-1emv8hj"),H(z,"aria-valuenow",e(K)),H(z,"title",n.title),G(z,"selected",e(x)),G(z,"row",d()),It=Gt(pt,It,{...n.attrs,class:n.input_classes,value:e(c),oninput:kt,type:o(),inputmode:h(),step:s(),min:r(),max:n.max},"svelte-1emv8hj")}),P(l,D),tt()}at(["pointerdown"]);var Ee=J('<div class="scene_renderer svelte-1hiky75"><!></div>');function Xn(l,n){et(n,!0);var t=Ee(),o=R(t);{var h=s=>{var r=_t(),d=Z(r);he(d,()=>n.Component,(a,c)=>{c(a,{get scene(){return n.scene},get renderer(){return n.renderer}})}),P(s,r)};L(o,s=>{s(h)})}V(t),B(()=>{it(t,"width",`${n.renderer.width??""}px`),it(t,"height",`${n.renderer.height??""}px`),it(t,"min-width",`${n.renderer.width??""}px`),it(t,"min-height",`${n.renderer.height??""}px`)}),P(l,t),tt()}const Pe=(l,n)=>{n(l.clientX,l.clientY),lt(l)};var Xe=rt('<polygon role="none" class="unit_circle_radius_handles svelte-1i5of7p" fill="var(--color_selected)"></polygon><!>',1);function Ce(l,n){et(n,!0);const t=nt(n,"unit",7),o=nt(n,"size",3,xt),h=.5;let s=f(!1),r=f(null),d=f(null),a=f(null),c=f(null),m=f(null),p=f(null),y=f(null);const x=T(()=>t().x),S=T(()=>t().y-Math.max(o(),t().radius*Math.abs(t().scale))),b=T(()=>o()/2),M=(g,E)=>{e(s)||(i(s,!0),i(r,u(t().radius)),i(d,u(g)),i(a,u(E)),i(c,u(g)),i(m,u(E)))},Y=()=>{i(s,!1),i(r,null),i(d,null),i(a,null),i(c,null),i(m,null),i(p,null),i(y,null)},v=(g,E)=>{i(c,u(e(p))),i(m,u(e(y))),i(p,u(g)),i(y,u(E)),e(c)!==null&&e(m)!==null&&(t().radius=le(e(r)+h*(e(p)-e(d)-(e(y)-e(a)))))},k=g=>{Y()},w=g=>{Y()},_=g=>{v(g.clientX,g.clientY)},I=g=>{g.key==="Escape"&&(t().radius=e(r),Y(),lt(g))};var K=Xe();A("pointerup",W,function(...g){var E;(E=e(s)?k:void 0)==null||E.apply(this,g)}),A("pointermove",W,function(...g){var E;(E=e(s)?_:void 0)==null||E.apply(this,g)}),A("pointerleave",W,function(...g){var E;(E=e(s)?w:void 0)==null||E.apply(this,g)}),A("keydown",W,function(...g){var E;(E=e(s)?I:void 0)==null||E.apply(this,g)},!0);var U=Z(K);U.__pointerdown=[Pe,M];var Q=q(U);{var O=g=>{gt(g,{get x_start(){return e(d)},get y_start(){return e(a)},get x_last(){return e(c)},get y_last(){return e(m)}})};L(Q,g=>{e(s)&&g(O)})}B(()=>{H(U,"points",`${e(x)-e(b)},${e(S)-e(b)} ${e(x)+e(b)},${e(S)-e(b)} ${e(x)??""},${e(S)+e(b)}`),G(U,"pressing",e(s))}),P(l,K),tt()}at(["pointerdown"]);const ze=(l,n)=>{n(l.clientX,l.clientY),lt(l)};var Ke=rt('<circle role="none" class="unit_scale_handles svelte-rpawlp" fill="var(--color_selected)"></circle><!>',1);function Dt(l,n){et(n,!0);const t=nt(n,"unit",7),o=nt(n,"size",3,xt),h=.01;let s=f(!1),r=f(null),d=f(null),a=f(null),c=f(null),m=f(null),p=f(null),y=f(null),x=f(null),S=f(null);const b=T(()=>t().scene.controller.pressing_alt?"move":"nesw-resize"),M=(g,E)=>{e(s)||(i(s,!0),i(r,u(t().scale)),i(d,u(t().x)),i(a,u(t().y)),i(c,u(g)),i(m,u(E)),i(p,u(g)),i(y,u(E)))},Y=()=>{i(s,!1),i(r,null),i(d,null),i(a,null),i(c,null),i(m,null),i(p,null),i(y,null),i(x,null),i(S,null)},v=(g,E)=>{i(p,u(e(x))),i(y,u(e(S))),i(x,u(g)),i(S,u(E)),e(p)!==null&&e(y)!==null&&(t().scene.controller.pressing_alt?t().move_center_to(t().x+(e(x)-e(p)),t().y+(e(S)-e(y))):t().scale=oe(e(r)+h*(e(x)-e(c)-(e(S)-e(m)))))},k=g=>{Y()},w=g=>{Y()},_=g=>{v(g.clientX,g.clientY)},I=g=>{g.key==="Escape"&&(t().scene.controller.pressing_alt?t().move_center_to(e(d),e(a)):t().scale=e(r),Y(),lt(g))};var K=Ke();A("pointerup",W,function(...g){var E;(E=e(s)?k:void 0)==null||E.apply(this,g)}),A("pointermove",W,function(...g){var E;(E=e(s)?_:void 0)==null||E.apply(this,g)}),A("pointerleave",W,function(...g){var E;(E=e(s)?w:void 0)==null||E.apply(this,g)}),A("keydown",W,function(...g){var E;(E=e(s)?I:void 0)==null||E.apply(this,g)},!0);var U=Z(K);U.__pointerdown=[ze,M];var Q=q(U);{var O=g=>{gt(g,{get x_start(){return e(c)},get y_start(){return e(m)},get x_last(){return e(p)},get y_last(){return e(y)}})};L(Q,g=>{e(s)&&g(O)})}B(()=>{H(U,"cx",t().x),H(U,"cy",t().y),H(U,"r",o()/2),G(U,"pressing",e(s)),it(U,"cursor",e(b))}),P(l,K),tt()}at(["pointerdown"]);var He=J("<!> <!>",1);function Te(l,n){var t=He(),o=Z(t);Dt(o,{get unit(){return n.unit}});var h=q(o,2);Ce(h,{get unit(){return n.unit}}),P(l,t)}const Ue=(l,n)=>{n(l.clientX,l.clientY),lt(l)};var Ae=rt('<polygon role="none" class="unit_polygon_point_handles svelte-1fl6mbc" fill="var(--color_selected)"></polygon><!>',1);function je(l,n){et(n,!0);const t=nt(n,"size",3,xt);let o=f(!1),h=f(null),s=f(null),r=f(null),d=f(null),a=f(null),c=f(null),m=f(null),p=f(null),y=f(u(n.point)),x=f(null),S=f(null),b=f(!1);const M=1,Y=T(()=>n.unit.x+n.transformed_point.x),v=T(()=>n.unit.y+n.transformed_point.y),k=T(()=>t()/2),w=T(()=>n.unit.scene.controller.pressing_ctrl&&n.unit.scene.controller.pressing_alt?"no-drop":n.unit.scene.controller.pressing_alt?n.unit.scene.controller.pressing_shift?"alias":"copy":"move"),_=(z,F)=>{if(n.unit.scene.controller.pressing_ctrl&&n.unit.scene.controller.pressing_alt){n.unit.points.length>3&&n.unit.remove_point(n.point);return}e(o)||(i(o,!0),n.unit.scene.controller.pressing_alt?(i(x,u(z)),i(S,u(F)),i(b,!1),i(y,u(n.point))):i(y,u(n.point)),i(h,u(e(y).x)),i(s,u(e(y).y)),i(r,u(z)),i(d,u(F)),i(a,u(z)),i(c,u(F)))},I=()=>{i(o,!1),i(h,null),i(s,null),i(r,null),i(d,null),i(a,null),i(c,null),i(m,null),i(p,null),i(x,null),i(S,null),i(b,!1),i(y,u(n.point))},K=(z,F)=>{if(i(a,u(e(m))),i(c,u(e(p))),i(m,u(z)),i(p,u(F)),n.unit.scene.controller.pressing_alt&&!e(b)&&e(x)!==null){const bt=z-e(x),pt=F-e(S);if(Math.hypot(bt,pt)>=M){i(b,!0);const kt=re(n.unit,n.point,z,F,e(r),e(d));i(y,u(n.unit.duplicate_point(n.point,kt)))}}e(a)!==null&&e(c)!==null&&n.unit.move_transformed_point(e(y),e(m)-e(a),e(p)-e(c))},U=z=>{I()},Q=z=>{I()},O=z=>{K(z.clientX,z.clientY)},g=z=>{z.key==="Escape"&&(n.unit.scene.controller.pressing_alt&&e(y)!==n.point?n.unit.remove_point(e(y)):(e(y).x=e(h),e(y).y=e(s),n.unit.update_points()),I(),lt(z))};var E=Ae();A("pointerup",W,function(...z){var F;(F=e(o)?U:void 0)==null||F.apply(this,z)}),A("pointermove",W,function(...z){var F;(F=e(o)?O:void 0)==null||F.apply(this,z)}),A("pointerleave",W,function(...z){var F;(F=e(o)?Q:void 0)==null||F.apply(this,z)}),A("keydown",W,function(...z){var F;(F=e(o)?g:void 0)==null||F.apply(this,z)},!0);var N=Z(E);N.__pointerdown=[Ue,_];var X=q(N);{var D=z=>{gt(z,{get x_start(){return e(r)},get y_start(){return e(d)},get x_last(){return e(a)},get y_last(){return e(c)}})};L(X,z=>{e(o)&&z(D)})}B(()=>{H(N,"points",`${e(Y)-e(k)},${e(v)-e(k)} ${e(Y)+e(k)},${e(v)-e(k)} ${e(Y)??""},${e(v)+e(k)}`),G(N,"pressing",e(o)),it(N,"cursor",e(w))}),P(l,E),tt()}at(["pointerdown"]);const De=(l,n)=>{n(l.clientX,l.clientY),lt(l)};var qe=rt('<polygon role="none" class="unit_polygon_rotation_handles svelte-tnupuo" fill="var(--color_selected)"></polygon><!>',1);function Be(l,n){et(n,!0);const t=nt(n,"unit",7),o=nt(n,"size",3,xt),h=.013;let s=f(!1),r=f(null),d=f(null),a=f(null),c=f(null),m=f(null),p=f(null),y=f(null),x=f(null),S=f(null);const b=T(()=>t().scene.controller.pressing_alt?"move":"ew-resize"),M=T(()=>t().x+o()*Math.cos(-1*(t().rotation-Math.PI/2))),Y=T(()=>t().y-o()*Math.sin(-1*(t().rotation-Math.PI/2))),v=T(()=>`${e(M)},${e(Y)-o()/2} ${e(M)+o()/3},${e(Y)} ${e(M)},${e(Y)+o()/2} ${e(M)-o()/3},${e(Y)}`),k=(X,D)=>{e(s)||(i(s,!0),i(r,u(t().rotation)),i(d,u(t().x)),i(a,u(t().y)),i(c,u(X)),i(m,u(D)),i(p,u(X)),i(y,u(D)))},w=()=>{i(s,!1),i(r,null),i(c,null),i(m,null),i(p,null),i(y,null),i(x,null),i(S,null)},_=(X,D)=>{i(p,u(e(x))),i(y,u(e(S))),i(x,u(X)),i(S,u(D)),e(p)!==null&&e(y)!==null&&(t().scene.controller.pressing_alt?t().move_center_to(t().x+(e(x)-e(p)),t().y+(e(S)-e(y))):t().rotation=se(e(r)+h*(e(x)-e(c)-(e(S)-e(m)))))},I=X=>{w()},K=X=>{w()},U=X=>{_(X.clientX,X.clientY)},Q=X=>{X.key==="Escape"&&(t().scene.controller.pressing_alt?t().move_center_to(e(d),e(a)):t().rotation=e(r),w(),lt(X))};var O=qe();A("pointerup",W,function(...X){var D;(D=e(s)?I:void 0)==null||D.apply(this,X)}),A("pointermove",W,function(...X){var D;(D=e(s)?U:void 0)==null||D.apply(this,X)}),A("pointerleave",W,function(...X){var D;(D=e(s)?K:void 0)==null||D.apply(this,X)}),A("keydown",W,function(...X){var D;(D=e(s)?Q:void 0)==null||D.apply(this,X)},!0);var g=Z(O);g.__pointerdown=[De,k];var E=q(g);{var N=X=>{gt(X,{get x_start(){return e(c)},get y_start(){return e(m)},get x_last(){return e(p)},get y_last(){return e(y)}})};L(E,X=>{e(s)&&X(N)})}B(()=>{H(g,"points",e(v)),H(g,"transform",`rotate(${t().rotation_degrees??""} ${e(M)??""} ${e(Y)??""})`),G(g,"pressing",e(s)),it(g,"cursor",e(b))}),P(l,O),tt()}at(["pointerdown"]);var Ne=J("<!> <!> <!>",1);function Re(l,n){et(n,!0);var t=Ne(),o=Z(t);Tt(o,18,()=>n.unit.points,r=>r,(r,d,a)=>{je(r,{get unit(){return n.unit},get point(){return d},get transformed_point(){return n.unit.transformed_points[e(a)]}})});var h=q(o,2);Dt(h,{get unit(){return n.unit}});var s=q(h,2);Be(s,{get unit(){return n.unit}}),P(l,t),tt()}function Ve(l,n){et(n,!0);const t=T(()=>n.unit.type);var o=_t(),h=Z(o);{var s=d=>{Te(d,{get unit(){return n.unit}})},r=d=>{var a=_t(),c=Z(a);{var m=y=>{Re(y,{get unit(){return n.unit}})},p=y=>{var x=ut();B(()=>ht(x,At(e(t)))),P(y,x)};L(c,y=>{e(t)==="polygon"?y(m):y(p,!1)},!0)}P(d,a)};L(h,d=>{e(t)==="circle"?d(s):d(r,!1)})}P(l,o),tt()}var We=J('<menu class="pane unstyled svelte-pa2qv7"><!></menu>'),Le=J('<li role="none" class="svelte-pa2qv7"><div class="menu_item plain selectable svelte-pa2qv7" role="menuitem" aria-label="contextmenu submenmu" tabindex="-1"><div class="content"><div class="icon"><!></div> <div class="title"><!></div></div> <div class="chevron svelte-pa2qv7" aria-hidden="true"></div></div> <!></li>');function Fe(l,n){et(n,!0);const t=ae.get(),o=t.add_submenu(),{layout:h}=t,s=T(()=>o.selected);let r=f(void 0);const d=Pt.get(),a=Pt.set();let c=f(0),m=f(0);zt(()=>{e(r)&&p(e(r),h,d)});const p=(_,I,K)=>{const{x:U,y:Q,width:O,height:g}=_.getBoundingClientRect();a.width=O,a.height=g;const E=U-e(c),N=Q-e(m),X=E+O+K.width-I.width;if(X<=0)i(c,u(K.width));else{const D=O-E;D<=0?i(c,-O):D>X?i(c,K.width-X):i(c,D-O)}i(m,u(Math.min(0,I.height-(N+g))))};var y=Le(),x=R(y),S=R(x),b=R(S),M=R(b);dt(M,()=>n.icon??Ct),V(b);var Y=q(b,2),v=R(Y);dt(v,()=>n.children),V(Y),V(S),st(2),V(x);var k=q(x,2);{var w=_=>{var I=We(),K=R(I);dt(K,()=>n.menu),V(I),fe(I,U=>i(r,U),()=>e(r)),B(()=>{it(I,"transform",`translate3d(${e(c)??""}px, ${e(m)??""}px, 0)`),it(I,"max-height",`${h.height??""}px`)}),P(_,I)};L(k,_=>{e(s)&&_(w)})}V(y),B(()=>{it(y,"--contextmenu_depth",o.depth),H(x,"aria-expanded",e(s)),G(x,"selected",e(s))}),A("mouseenter",x,_=>{lt(_),setTimeout(()=>t.select(o))}),P(l,y),tt()}var Oe=rt('<circle role="none"></circle>'),Ze=rt('<polygon role="none"></polygon>'),Je=rt('<svg class="unit_icon svelte-yrh1le"><!></svg>');function Ge(l,n){et(n,!0);const t=nt(n,"padding",3,2),o=T(()=>n.unit.type),h=T(()=>n.unit.points),s=T(()=>n.unit.rotation),r=100,d=r/2,a=T(()=>`rotate(${e(s)*360/(Math.PI*2)} ${d} ${d})`),c=T(()=>{if(e(o)!=="polygon"||!e(h).length)return"";const S=e(h).map(I=>I.x),b=e(h).map(I=>I.y),M=(Math.min(...S)+Math.max(...S))/2,Y=(Math.min(...b)+Math.max(...b))/2,v=Math.max(...e(h).map(I=>Math.sqrt((I.x-M)**2+(I.y-Y)**2))),k=(r-t()*2)/(v*2),w=r/2-M*k,_=r/2-Y*k;return e(h).map(I=>`${I.x*k+w},${I.y*k+_}`).join(" ")});var m=Je();H(m,"viewBox",`0 0 ${r} ${r}`);var p=R(m);{var y=S=>{var b=Oe();H(b,"cx",d),H(b,"cy",d),B(()=>{H(b,"r",(r-t()*2)/2.6),H(b,"fill",n.unit.color),H(b,"transform",e(a))}),P(S,b)},x=S=>{var b=_t(),M=Z(b);{var Y=k=>{var w=Ze();B(()=>{H(w,"points",e(c)),H(w,"fill",n.unit.color),H(w,"transform",e(a))}),P(k,w)},v=k=>{var w=ut();B(()=>ht(w,At(e(o)))),P(k,w)};L(M,k=>{e(o)==="polygon"?k(Y):k(v,!1)},!0)}P(S,b)};L(p,S=>{e(o)==="circle"?S(y):S(x,!1)})}V(m),P(l,m),tt()}var Qe=J("<!> <!> <!> <!>",1),$e=J("<small><code> </code></small>"),tn=J("Unit <!>",1),en=J('<div class="display_contents"><!></div>');function nn(l,n){et(n,!0);const t=d=>{var a=_t(),c=Z(a);{var m=p=>{Fe(p,{menu:S=>{var b=Qe(),M=Z(b);wt(M,{icon:"⎘",run:()=>{const _=n.unit.clone();_.x+=10,_.y+=10,n.scene.add_unit(_)},children:(_,I)=>{st();var K=ut("Duplicate unit");P(_,K)},$$slots:{default:!0}});var Y=q(M,2);{var v=_=>{wt(_,{icon:"◎",run:()=>{n.unit.create_new_point()},children:(I,K)=>{st();var U=ut("Add point to polygon");P(I,U)},$$slots:{default:!0}})};L(Y,_=>{n.unit.type==="polygon"&&_(v)})}var k=q(Y,2);wt(k,{icon:"⌸",run:async()=>{const _=JSON.stringify(n.unit.json);await navigator.clipboard.writeText(_)},children:(_,I)=>{st();var K=ut("Copy data to clipboard");P(_,K)},$$slots:{default:!0}});var w=q(k,2);wt(w,{icon:"✕",run:()=>{n.scene.remove_unit(n.unit)},children:(_,I)=>{st();var K=ut("Delete unit");P(_,K)},$$slots:{default:!0}}),P(S,b)},icon:S=>{Ge(S,{get unit(){return n.unit}})},children:(S,b)=>{st();var M=tn(),Y=q(Z(M));{var v=w=>{var _=ut();B(()=>ht(_,n.unit.name)),P(w,_)},k=w=>{var _=$e(),I=R(_),K=R(I,!0);V(I),V(_),B(()=>ht(K,n.unit.id_string)),P(w,_)};L(Y,w=>{n.unit.name?w(v):w(k,!1)})}P(S,M)},$$slots:{menu:!0,icon:!0,default:!0}})};L(c,p=>{n.unit&&p(m)})}P(d,a)};var o=_t(),h=Z(o);{var s=d=>{var a=en(),c=R(a);dt(c,()=>n.children),V(a),ue(a,(m,p)=>{var y;return(y=ce)==null?void 0:y(m,p)},()=>t),B(()=>H(a,"data-unit",n.unit.id)),P(d,a)},r=d=>{var a=_t(),c=Z(a);dt(c,()=>n.children),P(d,a)};L(h,d=>{n.unit?d(s):d(r,!1)})}P(l,o),tt()}const ln=()=>({selecting:!1,selection_start_x:0,selection_start_y:0,selection_width:0,selection_height:0,initial_pointer_x:0,initial_pointer_y:0});var mt,ot,ct;class on{constructor(n){Yt(this,"selection_threshold",0);vt(this,mt,f(u(ln())));vt(this,ot,f(u(new Set)));vt(this,ct,f(u(new Set)));this.helpers=n}get state(){return e($(this,mt))}set state(n){i($(this,mt),u(n))}has(n){return e($(this,ot)).has(n)}add(n){e($(this,ot)).add(n)}delete(n){e($(this,ot)).delete(n)}clear(){e($(this,ot)).clear()}get_selected_items(){return Array.from(e($(this,ot)))}handle_selection_start(n,t,o){const h=this.helpers.find_top_item(n,t),s=h&&this.has(h);if(this.state.initial_pointer_x=n,this.state.initial_pointer_y=t,i($(this,ct),u(new Set(e($(this,ot))))),o==="subtractive"&&s){this.delete(h);return}h&&o!=="subtractive"?(o==="normal"&&this.clear(),this.add(h)):o==="normal"&&this.clear()}start_drag(n,t){this.state.selecting=!0,this.state.selection_start_x=n,this.state.selection_start_y=t,this.state.selection_width=0,this.state.selection_height=0}update_drag(n,t,o){if(!this.state.selecting)return;this.state.selection_width=n-this.state.selection_start_x,this.state.selection_height=t-this.state.selection_start_y;const h=this.state.selection_width>=0?this.state.selection_start_x:n,s=this.state.selection_height>=0?this.state.selection_start_y:t,r=Math.abs(this.state.selection_width),d=Math.abs(this.state.selection_height),a=this.helpers.find_all_items(h,s,r,d);switch(o){case"additive":i($(this,ot),u(new Set(e($(this,ct)))));for(const c of a)this.add(c);break;case"subtractive":i($(this,ot),u(new Set(e($(this,ct)))));for(const c of a)this.delete(c);break;case"normal":this.clear();for(const c of a)this.add(c);break;default:throw new _e(o)}}end_drag(n,t,o){const h=n-this.state.initial_pointer_x,s=t-this.state.initial_pointer_y,r=Math.sqrt(h*h+s*s)>this.selection_threshold;this.state.selecting&&r&&this.update_drag(n,t,o),this.state.selecting=!1,this.state.selection_width=0,this.state.selection_height=0,e($(this,ct)).clear()}}mt=new WeakMap,ot=new WeakMap,ct=new WeakMap;const rn=(l,n,t,o,h,s,r,d)=>{n(l.offsetX,l.offsetY),t(t().pointer_down=!0,!0),t(t().drag_start_x=t().pointer_x,!0),t(t().drag_start_y=t().pointer_y,!0),t(t().drag_start_client_x=t(t().pointer_last_client_x=l.clientX,!0),!0),t(t().drag_start_client_y=t(t().pointer_last_client_y=l.clientY,!0),!0);const a=l.shiftKey&&l.ctrlKey&&!l.altKey;if(t().hovering_handle){!l.altKey&&l.shiftKey&&t().hovering_unit&&(t(t().dragging_unit=t().hovering_unit,!0),t(t().dragging_selection=!0,!0),o.unit_selection.has(t().hovering_unit)||((!l.ctrlKey||a)&&o.unit_selection.clear(),o.unit_selection.add(t().hovering_unit)),a&&e(h)&&s());return}const c=t().hovering_unit;if(c&&o.unit_selection.has(c)&&(l.shiftKey&&!l.altKey||!l.ctrlKey)){t(t().dragging_unit=c,!0),t(t().dragging_selection=!0,!0),a&&e(h)&&s();return}r.handle_selection_start(t().pointer_x,t().pointer_y,d(l)),o.unit_selection.clear();for(const p of r.get_selected_items())o.unit_selection.add(p)},sn=(l,n,t,o,h,s,r)=>{if(n(l.offsetX,l.offsetY),t.state.selecting){t.end_drag(o().pointer_x,o().pointer_y,h(l)),s.unit_selection.clear();for(const d of t.get_selected_items())s.unit_selection.add(d)}r()},an=(l,n,t,o,h,s)=>{if(n(l.offsetX,l.offsetY),t(t().pointer_last_client_x=l.clientX,!0),t(t().pointer_last_client_y=l.clientY,!0),t().pointer_down&&!t().dragging_unit){const r=t().pointer_x-o.state.initial_pointer_x,d=t().pointer_y-o.state.initial_pointer_y;Math.sqrt(r*r+d*d)>o.selection_threshold&&!o.state.selecting&&o.start_drag(o.state.initial_pointer_x,o.state.initial_pointer_y)}if(o.state.selecting){o.update_drag(t().pointer_x,t().pointer_y,h(l)),s.unit_selection.clear();for(const r of o.get_selected_items())s.unit_selection.add(r)}};var un=rt('<rect class="selection_rect svelte-1s96klh"></rect>'),cn=J('<div class="scene_interaction_surface svelte-1s96klh"><svg class="controls_layer svelte-1s96klh"><!><!></svg></div> <!>',1);function Cn(l,n){et(n,!0);const t=nt(n,"scene_interaction_surface_state",15),o=T(()=>n.scene.controller),h=v=>v,s=v=>v,r=new on({find_top_item:n.scene.find_top_unit_at_point,find_all_items:n.scene.find_all_units_in_rect}),d=v=>v.shiftKey&&v.ctrlKey?"additive":v.ctrlKey?"subtractive":v.shiftKey?"additive":"normal",a=T(()=>t().hovering_unit!==null&&n.unit_selection.has(t().hovering_unit)),c=(v,k)=>{const w=h(v),_=s(k),I=t().pointer_x,K=t().pointer_y;if(t(t().pointer_x=w,!0),t(t().pointer_y=_,!0),t().dragging_unit){const U=w-I,Q=_-K;for(const O of n.unit_selection)O.x+=U,O.y+=Q}else t(t().hovering_unit=n.scene.find_top_unit_at_point(w,_),!0),t().hovering_unit&&t(t().hovered_unit=t().hovering_unit,!0)},m=()=>{t(t().pointer_down=!1,!0),t(t().drag_start_x=null,!0),t(t().drag_start_y=null,!0),t(t().dragging_unit=null,!0),t(t().dragging_selection=!1,!0),t(t().drag_start_client_x=null,!0),t(t().drag_start_client_y=null,!0),t(t().pointer_last_client_x=null,!0),t(t().pointer_last_client_y=null,!0)},p=()=>{const v=[];for(const k of n.unit_selection){const w=k.clone();n.scene.add_unit(w),v.push(w)}n.unit_selection.clear(),r.clear();for(const k of v)n.unit_selection.add(k),r.add(k)},y=v=>{c(v.offsetX,v.offsetY),t(t().pointing=!0,!0)},x=v=>{c(v.offsetX,v.offsetY),t(t().pointing=!1,!0),t(t().hovering_unit=null,!0)},S=v=>{t().pointer_down&&t(t().pointer_down=!1,!0),t(t().dragging_unit=null,!0),t(t().dragging_selection=!1,!0)},b=v=>{(v.key==="Shift"||v.key==="Control")&&r.update_drag(t().pointer_x,t().pointer_y,d(v))},M=v=>{(v.key==="Shift"||v.key==="Control")&&r.update_drag(t().pointer_x,t().pointer_y,d(v))},Y=v=>{if(!de(v.target))return;const{key:k}=v;if(k==="Escape"){if(!t().dragging_unit)return;const w=t().pointer_x-t().drag_start_x,_=t().pointer_y-t().drag_start_y;for(const I of n.unit_selection)I.x-=w,I.y-=_;m(),lt(v)}else if(k==="Delete"){for(const w of n.unit_selection)n.scene.remove_unit(w);n.unit_selection.clear(),r.clear(),m(),lt(v)}};A("keydown",W,b),A("keyup",W,M),A("keydown",W,Y,!0),nn(l,{get scene(){return n.scene},get unit(){return t().hovered_unit},children:(v,k)=>{var w=cn(),_=Z(w);_.__pointerdown=[rn,c,t,n,a,p,r,d],_.__pointerup=[sn,c,r,t,d,n,m],_.__pointermove=[an,c,t,r,d,n];const I=T(()=>t().hovering_unit&&n.unit_selection.has(t().hovering_unit)&&!r.state.selecting&&!t().pointer_down);B(()=>G(_,"grabbable",e(I)));var K=R(_),U=R(K);Tt(U,16,()=>Array.from(n.unit_selection),N=>N,(N,X)=>{Ve(N,{get unit(){return X}})});var Q=q(U);{var O=N=>{var X=un();B(()=>H(X,"width",Math.abs(r.state.selection_width))),B(()=>H(X,"height",Math.abs(r.state.selection_height))),B(()=>{H(X,"x",r.state.selection_width>=0?r.state.selection_start_x:r.state.selection_start_x+r.state.selection_width),H(X,"y",r.state.selection_height>=0?r.state.selection_start_y:r.state.selection_start_y+r.state.selection_height)}),P(N,X)};L(Q,N=>{r.state.selecting&&N(O)})}V(K),V(_);var g=q(_,2);{var E=N=>{gt(N,{get x_start(){return t().drag_start_client_x},get y_start(){return t().drag_start_client_y},get x_last(){return t().pointer_last_client_x},get y_last(){return t().pointer_last_client_y}})};L(g,N=>{t().dragging_unit&&N(E)})}B(()=>{G(_,"pressing",t().pointer_down),G(_,"selecting",r.state.selecting),G(_,"hovering",!!t().hovering_unit),G(_,"hovering_selection",e(a)),G(_,"grabbing",t().dragging_unit!==null),G(_,"pressing_shift",e(o).pressing_shift),G(_,"pressing_ctrl",e(o).pressing_ctrl),G(_,"pressing_alt",e(o).pressing_alt),it(_,"width",`${n.width??""}px`),it(_,"height",`${n.height??""}px`),H(K,"width",n.width),H(K,"height",n.height)}),A("pointerenter",_,y),A("pointerleave",_,x),A("pointercancel",_,S),P(v,w)},$$slots:{default:!0}}),tt()}at(["pointerdown","pointerup","pointermove"]);var _n=J('<div class="flex align_items_end font_weight_700 px_md font_mono"><div class="text_align_right pr_xs"> </div> <div class="text_color_4">fps</div></div>');function zn(l,n){et(n,!0);const t=T(()=>n.clock??ve.get());var o=_n(),h=R(o);it(h,"width","4rem");var s=R(h,!0);V(h),st(2),V(o),B(()=>ht(s,e(t).average_fps)),P(l,o),tt()}var dn=(l,n)=>i(n,!0),vn=J("<p><strong>WASD</strong> and <strong>arrow keys</strong> to move the player</p>"),gn=J("<p><strong>` Backtick</strong> to toggle playing</p>"),hn=J('<div class="content pane svelte-1487nr8"><h2 class="mt_0">Global controls</h2> <!> <p><strong>r</strong> to reset</p> <p><strong>spacebar</strong> to toggle the clock</p> <!> <p><strong>~ Shift+Backtick</strong> to toggle editing</p> <p>edit with mouse and <strong>Ctrl</strong>/<strong>Shift</strong>/<strong>Alt</strong>:</p> <ul><li><strong>Shift</strong> to add to selection</li> <li><strong>Ctrl</strong> to remove from selection</li> <li><strong>Delete</strong> to delete the selected units</li> <li><strong>Shift+Ctrl</strong> to duplicate the selected units</li> <li><strong>Alt</strong> to recenter polygons</li> <li><strong>Alt</strong> to duplicate points</li> <li><strong>Alt+Ctrl</strong> to delete points</li></ul></div>'),fn=J('<button type="button">help</button> <!>',1);function Kn(l,n){et(n,!0);const t=Ut.get();let o=f(!1);var h=fn(),s=Z(h);s.__click=[dn,o];var r=q(s,2);{var d=a=>{ge(a,{onclose:()=>i(o,!1),children:(c,m)=>{var p=hn(),y=q(R(p),2);{var x=M=>{var Y=vn();P(M,Y)};L(y,M=>{t.player_input_enabled&&M(x)})}var S=q(y,6);{var b=M=>{var Y=gn();P(M,Y)};L(S,M=>{t.player_input_enabled&&M(b)})}st(6),V(p),P(c,p)},$$slots:{default:!0}})};L(r,a=>{e(o)&&a(d)})}P(l,h),tt()}at(["click"]);export{zn as F,Kn as H,En as S,Ge as U,Xn as a,Cn as b,Pn as c,nn as d};
