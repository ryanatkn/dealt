var Lt=Object.defineProperty;var Yt=l=>{throw TypeError(l)};var Vt=(l,n,t)=>n in l?Lt(l,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):l[n]=t;var Et=(l,n,t)=>Vt(l,typeof n!="symbol"?n+"":n,t),Xt=(l,n,t)=>n.has(l)||Yt("Cannot "+t);var Q=(l,n,t)=>(Xt(l,n,"read from private field"),t?t.call(l):n.get(l)),vt=(l,n,t)=>n.has(l)?Yt("Cannot add the same private member more than once"):n instanceof WeakSet?n.add(l):n.set(l,t),It=(l,n,t,r)=>(Xt(l,n,"write to private field"),r?r.call(l,t):n.set(l,t),t);import{t as Z,a as E,n as rt,c as ft,b as ct}from"./DyCZ_lw9.js";import{aM as Ft,w as e,ax as Wt,k as Ot,j as Ct,aj as Gt,m as tt,v as $,c as B,x as U,s as D,o as W,q as et,r as R,G as zt,n as ot,ai as g,a2 as gt,u as Kt,X as i,aL as L}from"./Dkaln31E.js";import{d as ut,o as Ht,k as A,s as yt}from"./DMs3BEDJ.js";import{i as V,p as nt}from"./Cr-AO5Xh.js";import{s as dt}from"./DQXgQxX-.js";import{g as st,c as at,s as H,r as Tt,j as Zt,a as Jt,b as Ut}from"./C07ZAADA.js";import{t as Qt,s as $t}from"./CD3rAWNL.js";import{ap as te,e as jt,P as ee,k as ne,aq as ie,Q as it,ar as St,as as le,at as re,au as oe,av as se,aw as At,K as ae,M as Pt,N as ue,a2 as ce,L as kt,ax as _e,a3 as de,c as ve,F as ge}from"./BERuEieG.js";import{c as he}from"./DDxrSoXw.js";import{b as fe}from"./DlVdBben.js";function ye(l){let n=0,t=Wt(0),r;return()=>{Ft()&&(e(t),Ot(()=>(n===0&&(r=Ct(()=>l(()=>te(t)))),n+=1,()=>{Gt().then(()=>{n-=1,n===0&&(r==null||r(),r=void 0)})})))}}var mt,pt;class Nt{constructor(n,t){vt(this,mt);vt(this,pt);It(this,mt,n),It(this,pt,ye(t))}get current(){return Q(this,pt).call(this),Q(this,mt).call(this)}}mt=new WeakMap,pt=new WeakMap;var me=(l,n)=>e(n).reset(),pe=Z('<fieldset><label class="row pt_xs"><input type="checkbox"> show bounding volume hierarchy</label></fieldset>'),we=Z('<div class="scene_controls svelte-1l7n56e"><button type="button" title="toggle the clock [Spacebar]"><div class="pr_sm">clock</div> <!></button> <button type="button" title="reset the scene [r]" class="plain">reset</button> <button type="button">edit</button> <!></div> <!>',1);function En(l,n){tt(n,!0);const t=U(()=>n.project.renderer),r=U(()=>n.project.scene),d=U(()=>e(r).clock),s=jt.get();var o=we(),_=$(o),u=B(_);u.__click=function(...w){var a;(a=e(d).toggle)==null||a.apply(this,w)};let c;st(u,"",{},{"min-width":"105px"});var y=D(B(u),2);ee(y,{get running(){return e(d).running}}),R(u);var m=D(u,2);m.__click=[me,r];var f=D(m,2);let k;f.__click=()=>s.editing=!s.editing;var p=D(f,2);dt(p,()=>n.children??zt),R(_);var M=D(_,2);{var Y=w=>{var a=pe(),x=B(a),b=B(x);Tt(b),ot(),R(x),R(a),ne(b,()=>e(t).show_bvh,h=>e(t).show_bvh=h),Qt(3,a,()=>$t),E(w,a)};V(M,w=>{e(t).type==="canvas"&&w(Y)})}W((w,a)=>{c=at(u,1,"",null,c,w),k=at(f,1,"plain deselectable",null,k,a),H(f,"title",`${(s.editing?"stop editing":"start editing")??""} [~ Shift+Backtick]`)},[()=>({color_d:e(d).running}),()=>({color_d:s.editing})]),E(l,o),et()}ut(["click"]);const xe=new Nt(()=>window.innerWidth,l=>Ht(window,"resize",l)),be=new Nt(()=>window.innerHeight,l=>Ht(window,"resize",l));var ke=rt('<line class="svelte-4z6b3j"></line>'),Se=rt('<svg class="scrubbing_indicator svelte-4z6b3j" aria-hidden="true"><!></svg>');function ht(l,n){tt(n,!0);const t=U(()=>n.container_width??xe.current),r=U(()=>n.container_height??be.current);ie(l,{to:document.body,children:(d,s)=>{var o=Se(),_=B(o);{var u=c=>{var y=ke();W(()=>{H(y,"x1",n.x_start),H(y,"y1",n.y_start),H(y,"x2",n.x_last),H(y,"y2",n.y_last)}),E(c,y)};V(_,c=>{n.x_start!==null&&n.y_start!==null&&n.x_last!==null&&n.y_last!==null&&c(u)})}R(o),W(()=>{H(o,"viewBox",`0 0 ${e(t)??""} ${e(r)??""}`),H(o,"width",e(t)),H(o,"height",e(r))}),E(d,o)},$$slots:{default:!0}}),et()}const Me=(l,n)=>{l.ctrlKey||n(l.clientX,l.clientY)};var Ie=Z('<div class="title svelte-1emv8hj"><!></div>'),Ye=Z('<label role="slider"><!> <input></label> <!>',1);function Xn(l,n){tt(n,!0);let t=nt(n,"value",15,0),r=nt(n,"type",3,"text"),d=nt(n,"inputmode",3,"numeric"),s=nt(n,"step",3,1),o=nt(n,"min",19,()=>1/0*-1),_=nt(n,"row",3,!1),u=g(gt(t())),c=g(gt(t().toString()));const y=C=>{var N;i(u,C,!0),t(Math.max(o(),C)),i(c,t().toString(),!0),(N=n.oninput)==null||N.call(n,t())};Kt(()=>{t()!==Ct(()=>e(u))&&(i(u,t(),!0),i(c,t().toString(),!0))});const m=C=>{i(c,C,!0);const N=parseFloat(C);Number.isNaN(N)||y(N)},f=C=>{y(e(u)+C)};let k=g(!1),p=g(null),M=g(null),Y=g(null),w=g(null),a=g(null),x=g(null),b=g(null);const h=U(()=>e(x)===null||e(w)===null?null:e(x)-e(w)),X=U(()=>e(b)===null||e(a)===null?null:e(a)-e(b)),z=U(()=>e(h)===null||e(X)===null?null:(e(h)+e(X))*s()),K=(C,N)=>{e(k)||(i(k,!0),i(p,t(),!0),i(M,C,!0),i(Y,N,!0),i(w,C,!0),i(a,N,!0))},q=()=>{i(k,!1),i(p,null),i(M,null),i(Y,null),i(w,null),i(a,null),i(x,null),i(b,null)},O=(C,N)=>{i(w,e(x),!0),i(a,e(b),!0),i(x,C,!0),i(b,N,!0),e(z)!==null&&f(e(z))},G=C=>{q()},S=C=>{q()},v=C=>{O(C.clientX,C.clientY)},P=C=>{C.key==="Escape"&&(y(e(p)),q(),it(C))};var J=Ye();A("pointerup",L,function(...C){var N;(N=e(k)?G:void 0)==null||N.apply(this,C)}),A("pointermove",L,function(...C){var N;(N=e(k)?v:void 0)==null||N.apply(this,C)}),A("pointerleave",L,function(...C){var N;(N=e(k)?S:void 0)==null||N.apply(this,C)}),A("keydown",L,function(...C){var N;(N=e(k)?P:void 0)==null||N.apply(this,C)},!0);var I=$(J);let j;I.__pointerdown=[Me,K];var T=B(I);{var F=C=>{var N=Ie(),Rt=B(N);dt(Rt,()=>n.children),R(N),E(C,N)};V(T,C=>{n.children&&C(F)})}var xt=D(T,2);Tt(xt);var Mt=C=>m(C.currentTarget.value);let bt;R(I);var Dt=D(I,2);{var Bt=C=>{ht(C,{get x_start(){return e(M)},get y_start(){return e(Y)},get x_last(){return e(w)},get y_last(){return e(a)}})};V(Dt,C=>{e(k)&&C(Bt)})}W(C=>{j=at(I,1,Zt(n.classes),"svelte-1emv8hj",j,C),H(I,"aria-valuenow",e(z)),H(I,"title",n.title),bt=Jt(xt,bt,{...n.attrs,class:n.input_classes,value:e(c),oninput:Mt,type:r(),inputmode:d(),step:s(),min:o(),max:n.max},"svelte-1emv8hj")},[()=>({selected:e(k),row:_()})]),E(l,J),et()}ut(["pointerdown"]);var Ee=Z('<div class="scene_renderer svelte-1hiky75"><!></div>');function Pn(l,n){tt(n,!0);var t=Ee();let r;var d=B(t);{var s=o=>{var _=ft(),u=$(_);he(u,()=>n.Component,(c,y)=>{y(c,{get scene(){return n.scene},get renderer(){return n.renderer}})}),E(o,_)};V(d,o=>{o(s)})}R(t),W(()=>r=st(t,"",r,{width:`${n.renderer.width??""}px`,height:`${n.renderer.height??""}px`,"min-width":`${n.renderer.width??""}px`,"min-height":`${n.renderer.height??""}px`})),E(l,t),et()}const Xe=(l,n)=>{n(l.clientX,l.clientY),it(l)};var Pe=rt('<polygon role="none" fill="var(--color_selected)"></polygon><!>',1);function Ce(l,n){tt(n,!0);const t=nt(n,"unit",7),r=nt(n,"size",3,St),d=.5;let s=g(!1),o=g(null),_=g(null),u=g(null),c=g(null),y=g(null),m=g(null),f=g(null);const k=U(()=>t().x),p=U(()=>t().y-Math.max(r(),t().radius*Math.abs(t().scale))),M=U(()=>r()/2),Y=(S,v)=>{e(s)||(i(s,!0),i(o,t().radius,!0),i(_,S,!0),i(u,v,!0),i(c,S,!0),i(y,v,!0))},w=()=>{i(s,!1),i(o,null),i(_,null),i(u,null),i(c,null),i(y,null),i(m,null),i(f,null)},a=(S,v)=>{i(c,e(m),!0),i(y,e(f),!0),i(m,S,!0),i(f,v,!0),e(c)!==null&&e(y)!==null&&(t().radius=le(e(o)+d*(e(m)-e(_)-(e(f)-e(u)))))},x=S=>{w()},b=S=>{w()},h=S=>{a(S.clientX,S.clientY)},X=S=>{S.key==="Escape"&&(t().radius=e(o),w(),it(S))};var z=Pe();A("pointerup",L,function(...S){var v;(v=e(s)?x:void 0)==null||v.apply(this,S)}),A("pointermove",L,function(...S){var v;(v=e(s)?h:void 0)==null||v.apply(this,S)}),A("pointerleave",L,function(...S){var v;(v=e(s)?b:void 0)==null||v.apply(this,S)}),A("keydown",L,function(...S){var v;(v=e(s)?X:void 0)==null||v.apply(this,S)},!0);var K=$(z);let q;K.__pointerdown=[Xe,Y];var O=D(K);{var G=S=>{ht(S,{get x_start(){return e(_)},get y_start(){return e(u)},get x_last(){return e(c)},get y_last(){return e(y)}})};V(O,S=>{e(s)&&S(G)})}W(S=>{q=at(K,0,"unit_circle_radius_handles svelte-1i5of7p",null,q,S),H(K,"points",`${e(k)-e(M)},${e(p)-e(M)} ${e(k)+e(M)},${e(p)-e(M)} ${e(k)??""},${e(p)+e(M)}`)},[()=>({pressing:e(s)})]),E(l,z),et()}ut(["pointerdown"]);const ze=(l,n)=>{n(l.clientX,l.clientY),it(l)};var Ke=rt('<circle role="none" fill="var(--color_selected)"></circle><!>',1);function qt(l,n){tt(n,!0);const t=nt(n,"unit",7),r=nt(n,"size",3,St),d=.01;let s=g(!1),o=g(null),_=g(null),u=g(null),c=g(null),y=g(null),m=g(null),f=g(null),k=g(null),p=g(null);const M=U(()=>t().scene.controller.pressing_alt?"move":"nesw-resize"),Y=(v,P)=>{e(s)||(i(s,!0),i(o,t().scale,!0),i(_,t().x,!0),i(u,t().y,!0),i(c,v,!0),i(y,P,!0),i(m,v,!0),i(f,P,!0))},w=()=>{i(s,!1),i(o,null),i(_,null),i(u,null),i(c,null),i(y,null),i(m,null),i(f,null),i(k,null),i(p,null)},a=(v,P)=>{i(m,e(k),!0),i(f,e(p),!0),i(k,v,!0),i(p,P,!0),e(m)!==null&&e(f)!==null&&(t().scene.controller.pressing_alt?t().move_center_to(t().x+(e(k)-e(m)),t().y+(e(p)-e(f))):t().scale=re(e(o)+d*(e(k)-e(c)-(e(p)-e(y)))))},x=v=>{w()},b=v=>{w()},h=v=>{a(v.clientX,v.clientY)},X=v=>{v.key==="Escape"&&(t().scene.controller.pressing_alt?t().move_center_to(e(_),e(u)):t().scale=e(o),w(),it(v))};var z=Ke();A("pointerup",L,function(...v){var P;(P=e(s)?x:void 0)==null||P.apply(this,v)}),A("pointermove",L,function(...v){var P;(P=e(s)?h:void 0)==null||P.apply(this,v)}),A("pointerleave",L,function(...v){var P;(P=e(s)?b:void 0)==null||P.apply(this,v)}),A("keydown",L,function(...v){var P;(P=e(s)?X:void 0)==null||P.apply(this,v)},!0);var K=$(z);let q;K.__pointerdown=[ze,Y];let O;var G=D(K);{var S=v=>{ht(v,{get x_start(){return e(c)},get y_start(){return e(y)},get x_last(){return e(m)},get y_last(){return e(f)}})};V(G,v=>{e(s)&&v(S)})}W(v=>{q=at(K,0,"unit_scale_handles svelte-rpawlp",null,q,v),H(K,"cx",t().x),H(K,"cy",t().y),H(K,"r",r()/2),O=st(K,"",O,{cursor:e(M)})},[()=>({pressing:e(s)})]),E(l,z),et()}ut(["pointerdown"]);var He=Z("<!> <!>",1);function Te(l,n){var t=He(),r=$(t);qt(r,{get unit(){return n.unit}});var d=D(r,2);Ce(d,{get unit(){return n.unit}}),E(l,t)}const Ue=(l,n)=>{n(l.clientX,l.clientY),it(l)};var je=rt('<polygon role="none" fill="var(--color_selected)"></polygon><!>',1);function Ae(l,n){tt(n,!0);const t=nt(n,"size",3,St);let r=g(!1),d=g(null),s=g(null),o=g(null),_=g(null),u=g(null),c=g(null),y=g(null),m=g(null),f=g(gt(n.point)),k=g(null),p=g(null),M=g(!1);const Y=1,w=U(()=>n.unit.x+n.transformed_point.x),a=U(()=>n.unit.y+n.transformed_point.y),x=U(()=>t()/2),b=U(()=>n.unit.scene.controller.pressing_ctrl&&n.unit.scene.controller.pressing_alt?"no-drop":n.unit.scene.controller.pressing_alt?n.unit.scene.controller.pressing_shift?"alias":"copy":"move"),h=(T,F)=>{if(n.unit.scene.controller.pressing_ctrl&&n.unit.scene.controller.pressing_alt){n.unit.points.length>3&&n.unit.remove_point(n.point);return}e(r)||(i(r,!0),n.unit.scene.controller.pressing_alt?(i(k,T,!0),i(p,F,!0),i(M,!1),i(f,n.point,!0)):i(f,n.point,!0),i(d,e(f).x,!0),i(s,e(f).y,!0),i(o,T,!0),i(_,F,!0),i(u,T,!0),i(c,F,!0))},X=()=>{i(r,!1),i(d,null),i(s,null),i(o,null),i(_,null),i(u,null),i(c,null),i(y,null),i(m,null),i(k,null),i(p,null),i(M,!1),i(f,n.point,!0)},z=(T,F)=>{if(i(u,e(y),!0),i(c,e(m),!0),i(y,T,!0),i(m,F,!0),n.unit.scene.controller.pressing_alt&&!e(M)&&e(k)!==null){const xt=T-e(k),Mt=F-e(p);if(Math.hypot(xt,Mt)>=Y){i(M,!0);const bt=oe(n.unit,n.point,T,F,e(o),e(_));i(f,n.unit.duplicate_point(n.point,bt),!0)}}e(u)!==null&&e(c)!==null&&n.unit.move_transformed_point(e(f),e(y)-e(u),e(m)-e(c))},K=T=>{X()},q=T=>{X()},O=T=>{z(T.clientX,T.clientY)},G=T=>{T.key==="Escape"&&(n.unit.scene.controller.pressing_alt&&e(f)!==n.point?n.unit.remove_point(e(f)):(e(f).x=e(d),e(f).y=e(s),n.unit.update_points()),X(),it(T))};var S=je();A("pointerup",L,function(...T){var F;(F=e(r)?K:void 0)==null||F.apply(this,T)}),A("pointermove",L,function(...T){var F;(F=e(r)?O:void 0)==null||F.apply(this,T)}),A("pointerleave",L,function(...T){var F;(F=e(r)?q:void 0)==null||F.apply(this,T)}),A("keydown",L,function(...T){var F;(F=e(r)?G:void 0)==null||F.apply(this,T)},!0);var v=$(S);let P;v.__pointerdown=[Ue,h];let J;var I=D(v);{var j=T=>{ht(T,{get x_start(){return e(o)},get y_start(){return e(_)},get x_last(){return e(u)},get y_last(){return e(c)}})};V(I,T=>{e(r)&&T(j)})}W(T=>{P=at(v,0,"unit_polygon_point_handles svelte-1fl6mbc",null,P,T),H(v,"points",`${e(w)-e(x)},${e(a)-e(x)} ${e(w)+e(x)},${e(a)-e(x)} ${e(w)??""},${e(a)+e(x)}`),J=st(v,"",J,{cursor:e(b)})},[()=>({pressing:e(r)})]),E(l,S),et()}ut(["pointerdown"]);const Ne=(l,n)=>{n(l.clientX,l.clientY),it(l)};var qe=rt('<polygon role="none" fill="var(--color_selected)"></polygon><!>',1);function De(l,n){tt(n,!0);const t=nt(n,"unit",7),r=nt(n,"size",3,St),d=.013;let s=g(!1),o=g(null),_=g(null),u=g(null),c=g(null),y=g(null),m=g(null),f=g(null),k=g(null),p=g(null);const M=U(()=>t().scene.controller.pressing_alt?"move":"ew-resize"),Y=U(()=>t().x+r()*Math.cos(-1*(t().rotation-Math.PI/2))),w=U(()=>t().y-r()*Math.sin(-1*(t().rotation-Math.PI/2))),a=U(()=>`${e(Y)},${e(w)-r()/2} ${e(Y)+r()/3},${e(w)} ${e(Y)},${e(w)+r()/2} ${e(Y)-r()/3},${e(w)}`),x=(I,j)=>{e(s)||(i(s,!0),i(o,t().rotation,!0),i(_,t().x,!0),i(u,t().y,!0),i(c,I,!0),i(y,j,!0),i(m,I,!0),i(f,j,!0))},b=()=>{i(s,!1),i(o,null),i(c,null),i(y,null),i(m,null),i(f,null),i(k,null),i(p,null)},h=(I,j)=>{i(m,e(k),!0),i(f,e(p),!0),i(k,I,!0),i(p,j,!0),e(m)!==null&&e(f)!==null&&(t().scene.controller.pressing_alt?t().move_center_to(t().x+(e(k)-e(m)),t().y+(e(p)-e(f))):t().rotation=se(e(o)+d*(e(k)-e(c)-(e(p)-e(y)))))},X=I=>{b()},z=I=>{b()},K=I=>{h(I.clientX,I.clientY)},q=I=>{I.key==="Escape"&&(t().scene.controller.pressing_alt?t().move_center_to(e(_),e(u)):t().rotation=e(o),b(),it(I))};var O=qe();A("pointerup",L,function(...I){var j;(j=e(s)?X:void 0)==null||j.apply(this,I)}),A("pointermove",L,function(...I){var j;(j=e(s)?K:void 0)==null||j.apply(this,I)}),A("pointerleave",L,function(...I){var j;(j=e(s)?z:void 0)==null||j.apply(this,I)}),A("keydown",L,function(...I){var j;(j=e(s)?q:void 0)==null||j.apply(this,I)},!0);var G=$(O);let S;G.__pointerdown=[Ne,x];let v;var P=D(G);{var J=I=>{ht(I,{get x_start(){return e(c)},get y_start(){return e(y)},get x_last(){return e(m)},get y_last(){return e(f)}})};V(P,I=>{e(s)&&I(J)})}W(I=>{S=at(G,0,"unit_polygon_rotation_handles svelte-tnupuo",null,S,I),H(G,"points",e(a)),H(G,"transform",`rotate(${t().rotation_degrees??""} ${e(Y)??""} ${e(w)??""})`),v=st(G,"",v,{cursor:e(M)})},[()=>({pressing:e(s)})]),E(l,O),et()}ut(["pointerdown"]);var Be=Z("<!> <!> <!>",1);function Re(l,n){tt(n,!0);var t=Be(),r=$(t);Ut(r,18,()=>n.unit.points,o=>o,(o,_,u)=>{Ae(o,{get unit(){return n.unit},get point(){return _},get transformed_point(){return n.unit.transformed_points[e(u)]}})});var d=D(r,2);qt(d,{get unit(){return n.unit}});var s=D(d,2);De(s,{get unit(){return n.unit}}),E(l,t),et()}function Le(l,n){tt(n,!0);const t=U(()=>n.unit.type);var r=ft(),d=$(r);{var s=_=>{Te(_,{get unit(){return n.unit}})},o=(_,u)=>{{var c=m=>{Re(m,{get unit(){return n.unit}})},y=m=>{var f=ct();W(k=>yt(f,k),[()=>At(e(t))]),E(m,f)};V(_,m=>{e(t)==="polygon"?m(c):m(y,!1)},u)}};V(d,_=>{e(t)==="circle"?_(s):_(o,!1)})}E(l,r),et()}var Ve=Z('<menu class="pane unstyled svelte-pa2qv7"><!></menu>'),Fe=Z('<li role="none" class="svelte-pa2qv7"><div role="menuitem" aria-label="contextmenu submenmu" tabindex="-1"><div class="content"><div class="icon"><!></div> <div class="title"><!></div></div> <div class="chevron svelte-pa2qv7" aria-hidden="true"></div></div> <!></li>');function We(l,n){tt(n,!0);const t=ae.get(),r=t.add_submenu(),{layout:d}=t,s=U(()=>r.selected);let o=g(void 0);const _=Pt.get(),u=Pt.set();let c=g(0),y=g(0);Kt(()=>{e(o)&&m(e(o),d,_)});const m=(z,K,q)=>{const{x:O,y:G,width:S,height:v}=z.getBoundingClientRect();u.width=S,u.height=v;const P=O-e(c),J=G-e(y),I=P+S+q.width-K.width;if(I<=0)i(c,q.width,!0);else{const j=S-P;j<=0?i(c,-S):j>I?i(c,q.width-I):i(c,j-S)}i(y,Math.min(0,K.height-(J+v)),!0)};var f=Fe();let k;var p=B(f);let M;var Y=B(p),w=B(Y),a=B(w);dt(a,()=>n.icon??zt),R(w);var x=D(w,2),b=B(x);dt(b,()=>n.children),R(x),R(Y),ot(2),R(p);var h=D(p,2);{var X=z=>{var K=Ve();let q;var O=B(K);dt(O,()=>n.menu),R(K),fe(K,G=>i(o,G),()=>e(o)),W(()=>q=st(K,"",q,{transform:`translate3d(${e(c)??""}px, ${e(y)??""}px, 0)`,"max-height":`${d.height??""}px`})),E(z,K)};V(h,z=>{e(s)&&z(X)})}R(f),W(z=>{k=st(f,"",k,{"--contextmenu_depth":r.depth}),M=at(p,1,"menu_item plain selectable svelte-pa2qv7",null,M,z),H(p,"aria-expanded",e(s))},[()=>({selected:e(s)})]),A("mouseenter",p,z=>{it(z),setTimeout(()=>t.select(r))}),E(l,f),et()}var Oe=rt('<circle role="none"></circle>'),Ge=rt('<polygon role="none"></polygon>'),Ze=rt('<svg class="unit_icon svelte-yrh1le"><!></svg>');function Je(l,n){tt(n,!0);const t=nt(n,"padding",3,2),r=U(()=>n.unit.type),d=U(()=>n.unit.points),s=U(()=>n.unit.rotation),o=100,_=o/2,u=U(()=>`rotate(${e(s)*360/(Math.PI*2)} ${_} ${_})`),c=U(()=>{if(e(r)!=="polygon"||!e(d).length)return"";const p=e(d).map(X=>X.x),M=e(d).map(X=>X.y),Y=(Math.min(...p)+Math.max(...p))/2,w=(Math.min(...M)+Math.max(...M))/2,a=Math.max(...e(d).map(X=>Math.sqrt((X.x-Y)**2+(X.y-w)**2))),x=(o-t()*2)/(a*2),b=o/2-Y*x,h=o/2-w*x;return e(d).map(X=>`${X.x*x+b},${X.y*x+h}`).join(" ")});var y=Ze();H(y,"viewBox",`0 0 ${o} ${o}`);var m=B(y);{var f=p=>{var M=Oe();H(M,"cx",_),H(M,"cy",_),W(()=>{H(M,"r",(o-t()*2)/2.6),H(M,"fill",n.unit.color),H(M,"transform",e(u))}),E(p,M)},k=(p,M)=>{{var Y=a=>{var x=Ge();W(()=>{H(x,"points",e(c)),H(x,"fill",n.unit.color),H(x,"transform",e(u))}),E(a,x)},w=a=>{var x=ct();W(b=>yt(x,b),[()=>At(e(r))]),E(a,x)};V(p,a=>{e(r)==="polygon"?a(Y):a(w,!1)},M)}};V(m,p=>{e(r)==="circle"?p(f):p(k,!1)})}R(y),E(l,y),et()}var Qe=Z("<!> <!> <!> <!>",1),$e=Z("<small><code> </code></small>"),tn=Z("Unit <!>",1),en=Z('<div class="display_contents"><!></div>');function nn(l,n){tt(n,!0);const t=_=>{var u=ft(),c=$(u);{var y=m=>{We(m,{menu:p=>{var M=Qe(),Y=$(M);kt(Y,{icon:"⎘",run:()=>{const h=n.unit.clone();h.x+=10,h.y+=10,n.scene.add_unit(h)},children:(h,X)=>{ot();var z=ct("Duplicate unit");E(h,z)},$$slots:{default:!0}});var w=D(Y,2);{var a=h=>{kt(h,{icon:"◎",run:()=>{n.unit.create_new_point()},children:(X,z)=>{ot();var K=ct("Add point to polygon");E(X,K)},$$slots:{default:!0}})};V(w,h=>{n.unit.type==="polygon"&&h(a)})}var x=D(w,2);kt(x,{icon:"⌸",run:async()=>{const h=JSON.stringify(n.unit.json);await navigator.clipboard.writeText(h)},children:(h,X)=>{ot();var z=ct("Copy data to clipboard");E(h,z)},$$slots:{default:!0}});var b=D(x,2);kt(b,{icon:"✕",run:()=>{n.scene.remove_unit(n.unit)},children:(h,X)=>{ot();var z=ct("Delete unit");E(h,z)},$$slots:{default:!0}}),E(p,M)},icon:p=>{Je(p,{get unit(){return n.unit}})},children:(p,M)=>{ot();var Y=tn(),w=D($(Y));{var a=b=>{var h=ct();W(()=>yt(h,n.unit.name)),E(b,h)},x=b=>{var h=$e(),X=B(h),z=B(X,!0);R(X),R(h),W(()=>yt(z,n.unit.id_string)),E(b,h)};V(w,b=>{n.unit.name?b(a):b(x,!1)})}E(p,Y)},$$slots:{menu:!0,icon:!0,default:!0}})};V(c,m=>{n.unit&&m(y)})}E(_,u)};var r=ft(),d=$(r);{var s=_=>{var u=en(),c=B(u);dt(c,()=>n.children),R(u),ue(u,(y,m)=>{var f;return(f=ce)==null?void 0:f(y,m)},()=>t),W(()=>H(u,"data-unit",n.unit.id)),E(_,u)},o=_=>{var u=ft(),c=$(u);dt(c,()=>n.children),E(_,u)};V(d,_=>{n.unit?_(s):_(o,!1)})}E(l,r),et()}const ln=()=>({selecting:!1,selection_start_x:0,selection_start_y:0,selection_width:0,selection_height:0,initial_pointer_x:0,initial_pointer_y:0});var wt,lt,_t;class rn{constructor(n){Et(this,"selection_threshold",0);vt(this,wt,g(gt(ln())));vt(this,lt,g(gt(new Set)));vt(this,_t,g(gt(new Set)));this.helpers=n}get state(){return e(Q(this,wt))}set state(n){i(Q(this,wt),n,!0)}has(n){return e(Q(this,lt)).has(n)}add(n){e(Q(this,lt)).add(n)}delete(n){e(Q(this,lt)).delete(n)}clear(){e(Q(this,lt)).clear()}get_selected_items(){return Array.from(e(Q(this,lt)))}handle_selection_start(n,t,r){const d=this.helpers.find_top_item(n,t),s=d&&this.has(d);if(this.state.initial_pointer_x=n,this.state.initial_pointer_y=t,i(Q(this,_t),new Set(e(Q(this,lt))),!0),r==="subtractive"&&s){this.delete(d);return}d&&r!=="subtractive"?(r==="normal"&&this.clear(),this.add(d)):r==="normal"&&this.clear()}start_drag(n,t){this.state.selecting=!0,this.state.selection_start_x=n,this.state.selection_start_y=t,this.state.selection_width=0,this.state.selection_height=0}update_drag(n,t,r){if(!this.state.selecting)return;this.state.selection_width=n-this.state.selection_start_x,this.state.selection_height=t-this.state.selection_start_y;const d=this.state.selection_width>=0?this.state.selection_start_x:n,s=this.state.selection_height>=0?this.state.selection_start_y:t,o=Math.abs(this.state.selection_width),_=Math.abs(this.state.selection_height),u=this.helpers.find_all_items(d,s,o,_);switch(r){case"additive":i(Q(this,lt),new Set(e(Q(this,_t))),!0);for(const c of u)this.add(c);break;case"subtractive":i(Q(this,lt),new Set(e(Q(this,_t))),!0);for(const c of u)this.delete(c);break;case"normal":this.clear();for(const c of u)this.add(c);break;default:throw new _e(r)}}end_drag(n,t,r){const d=n-this.state.initial_pointer_x,s=t-this.state.initial_pointer_y,o=Math.sqrt(d*d+s*s)>this.selection_threshold;this.state.selecting&&o&&this.update_drag(n,t,r),this.state.selecting=!1,this.state.selection_width=0,this.state.selection_height=0,e(Q(this,_t)).clear()}}wt=new WeakMap,lt=new WeakMap,_t=new WeakMap;const on=(l,n,t,r,d,s,o,_)=>{n(l.offsetX,l.offsetY),t(t().pointer_down=!0,!0),t(t().drag_start_x=t().pointer_x,!0),t(t().drag_start_y=t().pointer_y,!0),t(t().drag_start_client_x=t(t().pointer_last_client_x=l.clientX,!0),!0),t(t().drag_start_client_y=t(t().pointer_last_client_y=l.clientY,!0),!0);const u=l.shiftKey&&l.ctrlKey&&!l.altKey;if(t().hovering_handle){!l.altKey&&l.shiftKey&&t().hovering_unit&&(t(t().dragging_unit=t().hovering_unit,!0),t(t().dragging_selection=!0,!0),r.unit_selection.has(t().hovering_unit)||((!l.ctrlKey||u)&&r.unit_selection.clear(),r.unit_selection.add(t().hovering_unit)),u&&e(d)&&s());return}const c=t().hovering_unit;if(c&&r.unit_selection.has(c)&&(l.shiftKey&&!l.altKey||!l.ctrlKey)){t(t().dragging_unit=c,!0),t(t().dragging_selection=!0,!0),u&&e(d)&&s();return}o.handle_selection_start(t().pointer_x,t().pointer_y,_(l)),r.unit_selection.clear();for(const m of o.get_selected_items())r.unit_selection.add(m)},sn=(l,n,t,r,d,s,o)=>{if(n(l.offsetX,l.offsetY),t.state.selecting){t.end_drag(r().pointer_x,r().pointer_y,d(l)),s.unit_selection.clear();for(const _ of t.get_selected_items())s.unit_selection.add(_)}o()},an=(l,n,t,r,d,s)=>{if(n(l.offsetX,l.offsetY),t(t().pointer_last_client_x=l.clientX,!0),t(t().pointer_last_client_y=l.clientY,!0),t().pointer_down&&!t().dragging_unit){const o=t().pointer_x-r.state.initial_pointer_x,_=t().pointer_y-r.state.initial_pointer_y;Math.sqrt(o*o+_*_)>r.selection_threshold&&!r.state.selecting&&r.start_drag(r.state.initial_pointer_x,r.state.initial_pointer_y)}if(r.state.selecting){r.update_drag(t().pointer_x,t().pointer_y,d(l)),s.unit_selection.clear();for(const o of r.get_selected_items())s.unit_selection.add(o)}};var un=rt('<rect class="selection_rect svelte-1s96klh"></rect>'),cn=Z('<div><svg class="controls_layer svelte-1s96klh"><!><!></svg></div> <!>',1);function Cn(l,n){tt(n,!0);const t=nt(n,"scene_interaction_surface_state",15),r=U(()=>n.scene.controller),d=a=>a,s=a=>a,o=new rn({find_top_item:n.scene.find_top_unit_at_point,find_all_items:n.scene.find_all_units_in_rect}),_=a=>a.shiftKey&&a.ctrlKey?"additive":a.ctrlKey?"subtractive":a.shiftKey?"additive":"normal",u=U(()=>t().hovering_unit!==null&&n.unit_selection.has(t().hovering_unit)),c=(a,x)=>{const b=d(a),h=s(x),X=t().pointer_x,z=t().pointer_y;if(t(t().pointer_x=b,!0),t(t().pointer_y=h,!0),t().dragging_unit){const K=b-X,q=h-z;for(const O of n.unit_selection)O.x+=K,O.y+=q}else t(t().hovering_unit=n.scene.find_top_unit_at_point(b,h),!0),t().hovering_unit&&t(t().hovered_unit=t().hovering_unit,!0)},y=()=>{t(t().pointer_down=!1,!0),t(t().drag_start_x=null,!0),t(t().drag_start_y=null,!0),t(t().dragging_unit=null,!0),t(t().dragging_selection=!1,!0),t(t().drag_start_client_x=null,!0),t(t().drag_start_client_y=null,!0),t(t().pointer_last_client_x=null,!0),t(t().pointer_last_client_y=null,!0)},m=()=>{const a=[];for(const x of n.unit_selection){const b=x.clone();n.scene.add_unit(b),a.push(b)}n.unit_selection.clear(),o.clear();for(const x of a)n.unit_selection.add(x),o.add(x)},f=a=>{c(a.offsetX,a.offsetY),t(t().pointing=!0,!0)},k=a=>{c(a.offsetX,a.offsetY),t(t().pointing=!1,!0),t(t().hovering_unit=null,!0)},p=a=>{t().pointer_down&&t(t().pointer_down=!1,!0),t(t().dragging_unit=null,!0),t(t().dragging_selection=!1,!0)},M=a=>{(a.key==="Shift"||a.key==="Control")&&o.update_drag(t().pointer_x,t().pointer_y,_(a))},Y=a=>{(a.key==="Shift"||a.key==="Control")&&o.update_drag(t().pointer_x,t().pointer_y,_(a))},w=a=>{if(!de(a.target))return;const{key:x}=a;if(x==="Escape"){if(!t().dragging_unit)return;const b=t().pointer_x-t().drag_start_x,h=t().pointer_y-t().drag_start_y;for(const X of n.unit_selection)X.x-=b,X.y-=h;y(),it(a)}else if(x==="Delete"){for(const b of n.unit_selection)n.scene.remove_unit(b);n.unit_selection.clear(),o.clear(),y(),it(a)}};A("keydown",L,M),A("keyup",L,Y),A("keydown",L,w,!0),nn(l,{get scene(){return n.scene},get unit(){return t().hovered_unit},children:(a,x)=>{var b=cn(),h=$(b);let X;h.__pointerdown=[on,c,t,n,u,m,o,_],h.__pointerup=[sn,c,o,t,_,n,y],h.__pointermove=[an,c,t,o,_,n];let z;var K=B(h),q=B(K);Ut(q,16,()=>Array.from(n.unit_selection),P=>P,(P,J)=>{Le(P,{get unit(){return J}})});var O=D(q);{var G=P=>{var J=un();W((I,j)=>{H(J,"x",o.state.selection_width>=0?o.state.selection_start_x:o.state.selection_start_x+o.state.selection_width),H(J,"y",o.state.selection_height>=0?o.state.selection_start_y:o.state.selection_start_y+o.state.selection_height),H(J,"width",I),H(J,"height",j)},[()=>Math.abs(o.state.selection_width),()=>Math.abs(o.state.selection_height)]),E(P,J)};V(O,P=>{o.state.selecting&&P(G)})}R(K),R(h);var S=D(h,2);{var v=P=>{ht(P,{get x_start(){return t().drag_start_client_x},get y_start(){return t().drag_start_client_y},get x_last(){return t().pointer_last_client_x},get y_last(){return t().pointer_last_client_y}})};V(S,P=>{t().dragging_unit&&P(v)})}W(P=>{X=at(h,1,"scene_interaction_surface svelte-1s96klh",null,X,P),z=st(h,"",z,{width:`${n.width??""}px`,height:`${n.height??""}px`}),H(K,"width",n.width),H(K,"height",n.height)},[()=>({pressing:t().pointer_down,selecting:o.state.selecting,hovering:!!t().hovering_unit,hovering_selection:e(u),grabbable:t().hovering_unit&&n.unit_selection.has(t().hovering_unit)&&!o.state.selecting&&!t().pointer_down,grabbing:t().dragging_unit!==null,pressing_shift:e(r).pressing_shift,pressing_ctrl:e(r).pressing_ctrl,pressing_alt:e(r).pressing_alt})]),A("pointerenter",h,f),A("pointerleave",h,k),A("pointercancel",h,p),E(a,b)},$$slots:{default:!0}}),et()}ut(["pointerdown","pointerup","pointermove"]);var _n=Z('<div class="flex align_items_end font_weight_700 px_md font_mono"><div class="text_align_right pr_xs"> </div> <div class="text_color_4">fps</div></div>');function zn(l,n){tt(n,!0);const t=U(()=>n.clock??ve.get());var r=_n(),d=B(r);st(d,"",{},{width:"4rem"});var s=B(d,!0);R(d),ot(2),R(r),W(()=>yt(s,e(t).average_fps)),E(l,r),et()}var dn=(l,n)=>i(n,!0),vn=Z("<p><strong>WASD</strong> and <strong>arrow keys</strong> to move the player</p>"),gn=Z("<p><strong>` Backtick</strong> to toggle playing</p>"),hn=Z('<div class="content pane svelte-1487nr8"><h2 class="mt_0">Global controls</h2> <!> <p><strong>r</strong> to reset</p> <p><strong>spacebar</strong> to toggle the clock</p> <!> <p><strong>~ Shift+Backtick</strong> to toggle editing</p> <p>edit with mouse and <strong>Ctrl</strong>/<strong>Shift</strong>/<strong>Alt</strong>:</p> <ul><li><strong>Shift</strong> to add to selection</li> <li><strong>Ctrl</strong> to remove from selection</li> <li><strong>Delete</strong> to delete the selected units</li> <li><strong>Shift+Ctrl</strong> to duplicate the selected units</li> <li><strong>Alt</strong> to recenter polygons</li> <li><strong>Alt</strong> to duplicate points</li> <li><strong>Alt+Ctrl</strong> to delete points</li></ul></div>'),fn=Z('<button type="button">help</button> <!>',1);function Kn(l,n){tt(n,!0);const t=jt.get();let r=g(!1);var d=fn(),s=$(d);s.__click=[dn,r];var o=D(s,2);{var _=u=>{ge(u,{onclose:()=>i(r,!1),children:(c,y)=>{var m=hn(),f=D(B(m),2);{var k=Y=>{var w=vn();E(Y,w)};V(f,Y=>{t.player_input_enabled&&Y(k)})}var p=D(f,6);{var M=Y=>{var w=gn();E(Y,w)};V(p,Y=>{t.player_input_enabled&&Y(M)})}ot(6),R(m),E(c,m)},$$slots:{default:!0}})};V(o,u=>{e(r)&&u(_)})}E(l,d),et()}ut(["click"]);export{zn as F,Kn as H,En as S,Je as U,Pn as a,Cn as b,Xn as c,nn as d};
